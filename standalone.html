<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ïã§ÏãúÍ∞Ñ ÌôòÏú® Í≥ÑÏÇ∞Í∏∞ - ÌòÑÏßÄ ÌôîÌèêÎ•º ÎåÄÌïúÎØºÍµ≠ ÏõêÌôîÎ°ú Ï¶âÏãú Î≥ÄÌôò">
    <meta name="theme-color" content="#1a1a2e">
    <title>Ïã§ÏãúÍ∞Ñ ÌôòÏú® Í≥ÑÏÇ∞Í∏∞ (Îã®ÎèÖÏã§Ìñâ)</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Inline CSS -->
    <style>
        /* ===================================
   CSS Variables & Theme
   =================================== */
        :root {
            /* Colors - Dark Theme */
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: rgba(30, 30, 50, 0.8);
            --bg-input: rgba(255, 255, 255, 0.05);

            /* Accent Colors */
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --accent-glow: rgba(99, 102, 241, 0.3);

            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.5);

            /* Success/Result */
            --result-bg: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --result-glow: rgba(16, 185, 129, 0.3);

            /* Borders & Shadows */
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.4);
            --glass-blur: blur(20px);

            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;

            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;

            /* Typography */
            --font-family: 'Inter', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-md: 1rem;
            --font-size-lg: 1.25rem;
            --font-size-xl: 1.5rem;
            --font-size-2xl: 2rem;
            --font-size-3xl: 2.5rem;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }

        /* Light Theme */
        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #f5f5f7;
                --bg-secondary: #ffffff;
                --bg-card: rgba(255, 255, 255, 0.9);
                --bg-input: rgba(0, 0, 0, 0.05);
                --text-primary: #1a1a2e;
                --text-secondary: rgba(26, 26, 46, 0.7);
                --text-tertiary: rgba(26, 26, 46, 0.5);
                --border-color: rgba(0, 0, 0, 0.1);
                --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
                --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
                --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            }
        }

        /* ===================================
   Reset & Base Styles
   =================================== */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===================================
   App Container
   =================================== */
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-md);
            padding-top: env(safe-area-inset-top, var(--spacing-md));
            padding-bottom: env(safe-area-inset-bottom, var(--spacing-md));
        }

        /* ===================================
   Header
   =================================== */
        .app-header {
            text-align: center;
            padding: var(--spacing-lg) 0;
            margin-bottom: var(--spacing-md);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
        }

        .app-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .refresh-btn {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:hover {
            background: var(--accent-primary);
            color: var(--text-primary);
            transform: rotate(180deg);
        }

        .refresh-btn:active {
            transform: rotate(180deg) scale(0.95);
        }

        .rate-info {
            margin-top: var(--spacing-sm);
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
        }

        /* ===================================
   Calculator Main
   =================================== */
        .calculator-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .section-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        /* ===================================
   Currency Section
   =================================== */
        .currency-section {
            background: var(--bg-card);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }

        .currency-selector {
            margin-bottom: var(--spacing-md);
        }

        .current-rate {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            text-align: center;
        }

        .current-rate strong {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .rate-unit {
            color: var(--text-tertiary);
        }

        .location-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            border: 1px dashed var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-tertiary);
            font-size: var(--font-size-sm);
            font-family: var(--font-family);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .location-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* ===================================
   Amount Section
   =================================== */
        .amount-section {
            background: var(--bg-card);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
        }

        .amount-input-wrapper {
            display: flex;
            align-items: center;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            transition: all var(--transition-fast);
        }

        .amount-input-wrapper:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .currency-symbol {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--text-tertiary);
            margin-right: var(--spacing-sm);
        }

        .amount-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: var(--font-size-2xl);
            font-weight: 700;
            font-family: var(--font-family);
            color: var(--text-primary);
            text-align: right;
        }

        .amount-input:focus {
            outline: none;
        }

        .amount-input::placeholder {
            color: var(--text-tertiary);
        }

        /* Remove spinner for number input */
        .amount-input::-webkit-outer-spin-button,
        .amount-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .amount-input[type=number] {
            -moz-appearance: textfield;
        }

        /* ===================================
   Options Section
   =================================== */
        .options-section {
            background: var(--bg-card);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .options-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md) var(--spacing-lg);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            font-weight: 500;
            font-family: var(--font-family);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .options-toggle:hover {
            color: var(--text-primary);
        }

        .toggle-icon {
            font-size: var(--font-size-xs);
            transition: transform var(--transition-normal);
        }

        .toggle-icon.open {
            transform: rotate(180deg);
        }

        .options-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-normal);
        }

        .options-content.open {
            max-height: 400px;
        }

        .option-group {
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .option-label {
            display: block;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .option-row {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        .option-type-selector {
            display: flex;
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .type-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-size: var(--font-size-sm);
            font-weight: 500;
            font-family: var(--font-family);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .type-btn.active {
            background: var(--accent-primary);
            color: var(--text-primary);
        }

        .option-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm) var(--spacing-md);
        }

        .option-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: var(--font-size-md);
            font-family: var(--font-family);
            color: var(--text-primary);
            text-align: right;
            width: 60px;
        }

        .option-input:focus {
            outline: none;
        }

        .option-input::-webkit-outer-spin-button,
        .option-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .option-unit {
            font-size: var(--font-size-sm);
            color: var(--text-tertiary);
            margin-left: var(--spacing-xs);
        }

        /* ===================================
   Result Section
   =================================== */
        .result-section {
            background: var(--result-bg);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            text-align: center;
            box-shadow: var(--shadow-lg), 0 0 40px var(--result-glow);
            position: relative;
            overflow: hidden;
        }

        .result-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {

            0%,
            100% {
                transform: translateX(-30%) translateY(-30%);
            }

            50% {
                transform: translateX(10%) translateY(10%);
            }
        }

        .result-label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: var(--spacing-sm);
            position: relative;
        }

        .result-amount {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: var(--spacing-xs);
            position: relative;
        }

        .result-symbol {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .result-value {
            font-size: var(--font-size-3xl);
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -1px;
        }

        .result-breakdown {
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-md);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: var(--font-size-xs);
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.8;
            text-align: left;
            position: relative;
        }

        .result-breakdown .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-xs) 0;
        }

        .result-breakdown .breakdown-total {
            font-weight: 600;
            color: #ffffff;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            margin-top: var(--spacing-xs);
            padding-top: var(--spacing-sm);
        }

        /* ===================================
   Footer
   =================================== */
        .app-footer {
            text-align: center;
            padding: var(--spacing-lg) 0;
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
        }

        .disclaimer {
            margin-top: var(--spacing-xs);
            font-size: 0.65rem;
        }

        /* ===================================
   Responsive Design
   =================================== */

        /* Small phones */
        @media (max-width: 360px) {
            :root {
                --font-size-3xl: 2rem;
                --font-size-2xl: 1.5rem;
            }

            .app-container {
                padding: var(--spacing-sm);
            }
        }

        /* Landscape mode */
        @media (orientation: landscape) and (max-height: 500px) {
            .app-container {
                max-width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                gap: var(--spacing-md);
                padding: var(--spacing-sm) var(--spacing-lg);
            }

            .app-header {
                width: 100%;
                padding: var(--spacing-sm) 0;
                margin-bottom: 0;
            }

            .calculator-main {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: flex-start;
            }

            .currency-section,
            .amount-section {
                flex: 1;
                min-width: 280px;
            }

            .options-section,
            .result-section {
                flex: 1;
                min-width: 280px;
            }

            .app-footer {
                width: 100%;
                padding: var(--spacing-sm) 0;
            }
        }

        /* Tablet and larger */
        @media (min-width: 768px) {
            .app-container {
                max-width: 600px;
                padding: var(--spacing-xl);
            }

            :root {
                --font-size-3xl: 3rem;
            }
        }

        /* Foldable devices */
        @media (horizontal-viewport-segments: 2) {
            .app-container {
                max-width: 100%;
            }

            .calculator-main {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: var(--spacing-lg);
            }

            .result-section {
                grid-column: span 2;
            }
        }

        /* Safe area for notched devices */
        @supports (padding: max(0px)) {
            .app-container {
                padding-left: max(var(--spacing-md), env(safe-area-inset-left));
                padding-right: max(var(--spacing-md), env(safe-area-inset-right));
            }
        }

        /* New Interactive Currency UI */
        .currency-interaction-wrapper {
            position: relative;
            margin-bottom: var(--spacing-md);
        }

        .currency-display {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            padding: var(--spacing-md) 0;
            cursor: pointer;
            border-bottom: 2px solid var(--border-color);
            transition: all var(--transition-fast);
        }

        .currency-display:hover {
            border-color: var(--accent-primary);
        }

        .display-text {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        .edit-hint {
            font-size: var(--font-size-xs);
            color: var(--accent-primary);
            opacity: 0.7;
            transition: opacity var(--transition-fast);
        }

        .currency-search-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--accent-primary);
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .search-input-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .main-search-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: var(--font-size-md);
            color: var(--text-primary);
            padding: var(--spacing-sm);
        }

        .main-search-input:focus {
            outline: none;
        }

        .close-search-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: var(--font-size-lg);
            cursor: pointer;
            padding: var(--spacing-xs);
        }

        .dropdown-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .option-item {
            padding: 12px;
            cursor: pointer;
            transition: background var(--transition-fast);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-primary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .option-item:last-child {
            border-bottom: none;
        }

        .option-item:hover,
        .option-item.selected {
            background: var(--bg-input);
            color: var(--accent-primary);
        }

        .option-info {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .option-name {
            font-weight: 500;
        }

        .option-code {
            font-size: 0.8em;
            color: var(--text-tertiary);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">üí± ÌôòÏú® Í≥ÑÏÇ∞Í∏∞</h1>
                <button id="refreshRateBtn" class="refresh-btn" aria-label="ÌôòÏú® ÏÉàÎ°úÍ≥†Ïπ®">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6" />
                        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" />
                    </svg>
                </button>
            </div>
            <div class="rate-info">
                <span id="rateUpdateTime">ÌôòÏú® Ï†ïÎ≥¥ Î°úÎî© Ï§ë...</span>
            </div>
        </header>

        <!-- Main Calculator Section -->
        <main class="calculator-main">
            <!-- Amount Input -->
            <section class="amount-section">
                <label for="localAmount" class="section-label">ÌòÑÏßÄ Í∏àÏï°</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol" id="currencySymbol">$</span>
                    <input type="text" id="localAmount" class="amount-input" placeholder="0" inputmode="decimal"
                        autocomplete="off">
                </div>
            </section>

            <!-- Result Section -->
            <section class="result-section">
                <div class="result-label">ÎåÄÌïúÎØºÍµ≠ ÏõêÌôî</div>
                <div class="result-amount">
                    <span class="result-symbol">‚Ç©</span>
                    <span class="result-value" id="resultValue">0</span>
                </div>
                <div class="result-breakdown" id="resultBreakdown">
                    <!-- Breakdown injected by JS -->
                </div>
            </section>

            <!-- Options Section -->
            <section class="options-section">
                <button class="options-toggle" id="optionsToggle">
                    <span>Ï∂îÍ∞Ä ÏòµÏÖò</span>
                    <span class="toggle-icon" id="toggleIcon">‚ñº</span>
                </button>

                <div class="options-content" id="optionsContent">
                    <!-- Service Charge -->
                    <div class="option-group">
                        <label class="option-label">ÏÑúÎπÑÏä§Ï∞®ÏßÄ (ÌåÅ)</label>
                        <div class="option-row">
                            <div class="option-type-selector">
                                <button class="type-btn active" data-type="percent" id="tipPercentBtn">%</button>
                                <button class="type-btn" data-type="fixed" id="tipFixedBtn">Ï†ïÏï°</button>
                            </div>
                            <div class="option-input-wrapper">
                                <input type="text" id="serviceCharge" class="option-input" placeholder="0"
                                    inputmode="decimal" autocomplete="off">
                                <span class="option-unit" id="serviceChargeUnit">%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tax Rate -->
                    <div class="option-group">
                        <label class="option-label">ÏÑ∏Í∏àÏú®</label>
                        <div class="option-input-wrapper">
                            <input type="text" id="taxRate" class="option-input" placeholder="0" inputmode="decimal"
                                autocomplete="off">
                            <span class="option-unit">%</span>
                        </div>
                    </div>

                    <!-- Fee Rate -->
                    <div class="option-group">
                        <label class="option-label">ÏàòÏàòÎ£åÏú®</label>
                        <div class="option-input-wrapper">
                            <input type="text" id="feeRate" class="option-input" placeholder="0" inputmode="decimal"
                                autocomplete="off">
                            <span class="option-unit">%</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Currency Selection -->
            <section class="currency-section">
                <div class="currency-selector">
                    <label class="section-label">ÌòÑÏßÄ ÌôîÌèê Î≥ÄÍ≤Ω</label>
                    <div class="currency-interaction-wrapper">
                        <!-- Display Mode -->
                        <div id="currencyDisplay" class="currency-display" role="button" tabindex="0">
                            <span id="selectedCurrencyText" class="display-text">ÎØ∏Íµ≠ (USD)</span>
                            <span class="edit-hint">‚úé Î≥ÄÍ≤Ω</span>
                        </div>

                        <!-- Input Mode -->
                        <div id="currencySearchWrapper" class="currency-search-wrapper" style="display: none;">
                            <div class="search-input-container">
                                <input type="text" id="currencySearchInput" class="main-search-input"
                                    placeholder="Íµ≠Í∞ÄÎ™Ö ÎòêÎäî ÌôîÌèêÎ™Ö Í≤ÄÏÉâ..." autocomplete="off">
                                <button id="closeSearchBtn" class="close-search-btn" aria-label="Îã´Í∏∞">‚úï</button>
                            </div>

                            <div class="dropdown-list" id="currencyOptionsList">
                                <!-- Options populated by JS -->
                            </div>
                        </div>
                    </div>

                    <button id="detectLocationBtn" class="location-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <circle cx="12" cy="12" r="3" />
                            <line x1="12" y1="2" x2="12" y2="6" />
                            <line x1="12" y1="18" x2="12" y2="22" />
                            <line x1="18" y1="12" x2="22" y2="12" />
                            <line x1="18" y1="12" x2="22" y2="12" />
                        </svg>
                        <span>ÌòÑÏû¨ ÏúÑÏπòÎ°ú Ï∞æÍ∏∞</span>
                    </button>

                    <div class="current-rate" style="margin-top: 10px;">
                        <span>Ï†ÅÏö© ÌôòÏú®: </span>
                        <strong id="currentRateDisplay">-</strong>
                        <span class="rate-unit">Ïõê</span>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>ÌôòÏú® Ï†ïÎ≥¥: ÌïòÎÇòÏùÄÌñâ Í≥†Ïãú Í∏∞Ï§Ä (Ïò§ÌîÑÎùºÏù∏ Ïãú Í∑ºÏÇ¨Í∞í)</p>
            <p class="disclaimer">‚Äª Ïã§Ï†ú ÌôòÏ†Ñ Ïãú ÌôòÏú®ÏùÄ Îã§Î•º Ïàò ÏûàÏäµÎãàÎã§</p>
        </footer>
    </div>

    <!-- Inline JS -->
    <script>
        /**
         * ÌôòÏú® Í≥ÑÏÇ∞Í∏∞ Ïï± - Standalone Bundle
         */

        // ===================================
        // Configuration & Constants
        // ===================================

        const CONFIG = {
            PROXIES: [
                'https://corsproxy.io/?',
                'https://api.allorigins.win/raw?url='
            ],
            TARGET_URL: 'https://api.stock.naver.com/marketindex/exchanges',
            GEO_API: 'https://api.bigdatacloud.net/data/reverse-geocode-client',
            UPDATE_INTERVAL: 5 * 60 * 1000
        };

        const FALLBACK_DATA = [
            { "symbolCode": "USD", "name": "ÎØ∏Íµ≠ USD", "stockExchangeType": { "nationCode": "USA", "nationName": "ÎØ∏Íµ≠" }, "calcPrice": "1423.80", "closePrice": "1,423.80", "unit": "KRW" },
            { "symbolCode": "EUR", "name": "Ïú†ÎüΩ EUR", "stockExchangeType": { "nationCode": "EU", "nationName": "Ïú†ÎüΩÏó∞Ìï©" }, "calcPrice": "1708.63", "closePrice": "1,708.63", "unit": "KRW" },
            { "symbolCode": "JPY", "name": "ÏùºÎ≥∏ JPY (100Ïóî)", "stockExchangeType": { "nationCode": "JPN", "nationName": "ÏùºÎ≥∏" }, "calcPrice": "933.24", "closePrice": "933.24", "unit": "KRW" },
            { "symbolCode": "CNY", "name": "Ï§ëÍµ≠ CNY", "stockExchangeType": { "nationCode": "CHN", "nationName": "Ï§ëÍµ≠" }, "calcPrice": "205.21", "closePrice": "205.21", "unit": "KRW" },
            { "symbolCode": "HKD", "name": "ÌôçÏΩ© HKD", "stockExchangeType": { "nationCode": "HKG", "nationName": "ÌôçÏΩ©" }, "calcPrice": "182.50", "closePrice": "182.50", "unit": "KRW" },
            { "symbolCode": "TWD", "name": "ÎåÄÎßå TWD", "stockExchangeType": { "nationCode": "TWN", "nationName": "ÎåÄÎßå" }, "calcPrice": "44.80", "closePrice": "44.80", "unit": "KRW" },
            { "symbolCode": "GBP", "name": "ÏòÅÍµ≠ GBP", "stockExchangeType": { "nationCode": "GBR", "nationName": "ÏòÅÍµ≠" }, "calcPrice": "1800.50", "closePrice": "1,800.50", "unit": "KRW" },
            { "symbolCode": "CAD", "name": "Ï∫êÎÇòÎã§ CAD", "stockExchangeType": { "nationCode": "CAN", "nationName": "Ï∫êÎÇòÎã§" }, "calcPrice": "1050.20", "closePrice": "1,050.20", "unit": "KRW" },
            { "symbolCode": "CHF", "name": "Ïä§ÏúÑÏä§ CHF", "stockExchangeType": { "nationCode": "CHE", "nationName": "Ïä§ÏúÑÏä§" }, "calcPrice": "1580.40", "closePrice": "1,580.40", "unit": "KRW" },
            { "symbolCode": "AUD", "name": "Ìò∏Ï£º AUD", "stockExchangeType": { "nationCode": "AUS", "nationName": "Ìò∏Ï£º" }, "calcPrice": "920.30", "closePrice": "920.30", "unit": "KRW" },
            { "symbolCode": "SGD", "name": "Ïã±Í∞ÄÌè¨Î•¥ SGD", "stockExchangeType": { "nationCode": "SGP", "nationName": "Ïã±Í∞ÄÌè¨Î•¥" }, "calcPrice": "1050.80", "closePrice": "1,050.80", "unit": "KRW" },
            { "symbolCode": "THB", "name": "ÌÉúÍµ≠ THB", "stockExchangeType": { "nationCode": "THA", "nationName": "ÌÉúÍµ≠" }, "calcPrice": "41.50", "closePrice": "41.50", "unit": "KRW" },
            { "symbolCode": "IDR", "name": "Ïù∏ÎèÑÎÑ§ÏãúÏïÑ IDR 100", "stockExchangeType": { "nationCode": "IDN", "nationName": "Ïù∏ÎèÑÎÑ§ÏãúÏïÑ" }, "calcPrice": "9.00", "closePrice": "9.00", "unit": "KRW" },
            { "symbolCode": "VND", "name": "Î≤†Ìä∏ÎÇ® VND 100", "stockExchangeType": { "nationCode": "VNM", "nationName": "Î≤†Ìä∏ÎÇ®" }, "calcPrice": "6.00", "closePrice": "6.00", "unit": "KRW" },
            { "symbolCode": "MYR", "name": "ÎßêÎ†àÏù¥ÏãúÏïÑ MYR", "stockExchangeType": { "nationCode": "MYS", "nationName": "ÎßêÎ†àÏù¥ÏãúÏïÑ" }, "calcPrice": "318.50", "closePrice": "318.50", "unit": "KRW" },
            { "symbolCode": "PHP", "name": "ÌïÑÎ¶¨ÌïÄ PHP", "stockExchangeType": { "nationCode": "PHL", "nationName": "ÌïÑÎ¶¨ÌïÄ" }, "calcPrice": "25.20", "closePrice": "25.20", "unit": "KRW" },
            { "symbolCode": "ZAR", "name": "ÎÇ®ÏïÑÍ≥µ ZAR", "stockExchangeType": { "nationCode": "ZAF", "nationName": "ÎÇ®ÏïÑÌîÑÎ¶¨Ïπ¥Í≥µÌôîÍµ≠" }, "calcPrice": "78.50", "closePrice": "78.50", "unit": "KRW" },
            { "symbolCode": "RUB", "name": "Îü¨ÏãúÏïÑ RUB", "stockExchangeType": { "nationCode": "RUS", "nationName": "Îü¨ÏãúÏïÑ" }, "calcPrice": "15.20", "closePrice": "15.20", "unit": "KRW" },
            { "symbolCode": "TRY", "name": "ÌäÄÎ•¥ÌÇ§Ïòà TRY", "stockExchangeType": { "nationCode": "TUR", "nationName": "ÌäÄÎ•¥ÌÇ§Ïòà" }, "calcPrice": "40.50", "closePrice": "40.50", "unit": "KRW" },
            { "symbolCode": "BRL", "name": "Î∏åÎùºÏßà BRL", "stockExchangeType": { "nationCode": "BRA", "nationName": "Î∏åÎùºÏßà" }, "calcPrice": "245.20", "closePrice": "245.20", "unit": "KRW" },
            { "symbolCode": "MXN", "name": "Î©ïÏãúÏΩî MXN", "stockExchangeType": { "nationCode": "MEX", "nationName": "Î©ïÏãúÏΩî" }, "calcPrice": "72.10", "closePrice": "72.10", "unit": "KRW" },
            { "symbolCode": "AED", "name": "UAE AED", "stockExchangeType": { "nationCode": "ARE", "nationName": "ÏïÑÎûçÏóêÎØ∏Î¶¨Ìä∏" }, "calcPrice": "387.60", "closePrice": "387.60", "unit": "KRW" },
            { "symbolCode": "INR", "name": "Ïù∏ÎèÑ INR", "stockExchangeType": { "nationCode": "IND", "nationName": "Ïù∏ÎèÑ" }, "calcPrice": "16.80", "closePrice": "16.80", "unit": "KRW" },
            { "symbolCode": "SAR", "name": "ÏÇ¨Ïö∞Îîî SAR", "stockExchangeType": { "nationCode": "SAU", "nationName": "ÏÇ¨Ïö∞ÎîîÏïÑÎùºÎπÑÏïÑ" }, "calcPrice": "379.50", "closePrice": "379.50", "unit": "KRW" },
            { "symbolCode": "NZD", "name": "Îâ¥ÏßàÎûúÎìú NZD", "stockExchangeType": { "nationCode": "NZL", "nationName": "Îâ¥ÏßàÎûúÎìú" }, "calcPrice": "850.20", "closePrice": "850.20", "unit": "KRW" },
            { "symbolCode": "CZK", "name": "Ï≤¥ÏΩî CZK", "stockExchangeType": { "nationCode": "CZE", "nationName": "Ï≤¥ÏΩî" }, "calcPrice": "60.50", "closePrice": "60.50", "unit": "KRW" },
            { "symbolCode": "PLN", "name": "Ìè¥ÎûÄÎìú PLN", "stockExchangeType": { "nationCode": "POL", "nationName": "Ìè¥ÎûÄÎìú" }, "calcPrice": "355.40", "closePrice": "355.40", "unit": "KRW" },
            { "symbolCode": "HUF", "name": "ÌóùÍ∞ÄÎ¶¨ HUF", "stockExchangeType": { "nationCode": "HUN", "nationName": "ÌóùÍ∞ÄÎ¶¨" }, "calcPrice": "3.80", "closePrice": "3.80", "unit": "KRW" }
        ];

        const CURRENCY_NAMES = {
            'USD': { name: 'ÎØ∏Íµ≠ Îã¨Îü¨', nation: 'ÎØ∏Íµ≠' },
            'EUR': { name: 'Ïú†ÎüΩ Ïú†Î°ú', nation: 'Ïú†ÎüΩÏó∞Ìï©' },
            'JPY': { name: 'ÏùºÎ≥∏ Ïóî', nation: 'ÏùºÎ≥∏' },
            'CNY': { name: 'Ï§ëÍµ≠ ÏúÑÏïà', nation: 'Ï§ëÍµ≠' },
            'HKD': { name: 'ÌôçÏΩ© Îã¨Îü¨', nation: 'ÌôçÏΩ©' },
            'TWD': { name: 'ÎåÄÎßå Îã¨Îü¨', nation: 'ÎåÄÎßå' },
            'GBP': { name: 'ÏòÅÍµ≠ ÌååÏö¥Îìú', nation: 'ÏòÅÍµ≠' },
            'CAD': { name: 'Ï∫êÎÇòÎã§ Îã¨Îü¨', nation: 'Ï∫êÎÇòÎã§' },
            'CHF': { name: 'Ïä§ÏúÑÏä§ ÌîÑÎûë', nation: 'Ïä§ÏúÑÏä§' },
            'SEK': { name: 'Ïä§Ïõ®Îç¥ ÌÅ¨Î°úÎÇò', nation: 'Ïä§Ïõ®Îç¥' },
            'AUD': { name: 'Ìò∏Ï£º Îã¨Îü¨', nation: 'Ìò∏Ï£º' },
            'NZD': { name: 'Îâ¥ÏßàÎûúÎìú Îã¨Îü¨', nation: 'Îâ¥ÏßàÎûúÎìú' },
            'CZK': { name: 'Ï≤¥ÏΩî ÏΩîÎ£®ÎÇò', nation: 'Ï≤¥ÏΩî' },
            'TRY': { name: 'ÌäÄÎ•¥ÌÇ§Ïòà Î¶¨Îùº', nation: 'ÌäÄÎ•¥ÌÇ§Ïòà' },
            'MXN': { name: 'Î©ïÏãúÏΩî ÌéòÏÜå', nation: 'Î©ïÏãúÏΩî' },
            'PLN': { name: 'Ìè¥ÎûÄÎìú Ï¶àÏõåÌã∞', nation: 'Ìè¥ÎûÄÎìú' },
            'AED': { name: 'UAE ÎîîÎ•¥Ìï®', nation: 'ÏïÑÎûçÏóêÎØ∏Î¶¨Ìä∏' },
            'SGD': { name: 'Ïã±Í∞ÄÌè¨Î•¥ Îã¨Îü¨', nation: 'Ïã±Í∞ÄÌè¨Î•¥' },
            'THB': { name: 'ÌÉúÍµ≠ Î∞îÌä∏', nation: 'ÌÉúÍµ≠' },
            'MYR': { name: 'ÎßêÎ†àÏù¥ÏãúÏïÑ ÎßÅÍπÉ', nation: 'ÎßêÎ†àÏù¥ÏãúÏïÑ' },
            'IDR': { name: 'Ïù∏ÎèÑÎÑ§ÏãúÏïÑ Î£®ÌîºÏïÑ', nation: 'Ïù∏ÎèÑÎÑ§ÏãúÏïÑ' },
            'VND': { name: 'Î≤†Ìä∏ÎÇ® Îèô', nation: 'Î≤†Ìä∏ÎÇ®' },
            'PHP': { name: 'ÌïÑÎ¶¨ÌïÄ ÌéòÏÜå', nation: 'ÌïÑÎ¶¨ÌïÄ' },
            'RUB': { name: 'Îü¨ÏãúÏïÑ Î£®Î∏î', nation: 'Îü¨ÏãúÏïÑ' },
            'ZAR': { name: 'ÎÇ®ÏïÑÍ≥µ ÎûúÎìú', nation: 'ÎÇ®ÏïÑÌîÑÎ¶¨Ïπ¥Í≥µÌôîÍµ≠' },
            'BRL': { name: 'Î∏åÎùºÏßà Î†àÏïå', nation: 'Î∏åÎùºÏßà' },
            'INR': { name: 'Ïù∏ÎèÑ Î£®Ìîº', nation: 'Ïù∏ÎèÑ' },
            'SAR': { name: 'ÏÇ¨Ïö∞Îîî Î¶¨ÏñÑ', nation: 'ÏÇ¨Ïö∞ÎîîÏïÑÎùºÎπÑÏïÑ' },
            'KWD': { name: 'Ïø†Ïõ®Ïù¥Ìä∏ ÎîîÎÇòÎ•¥', nation: 'Ïø†Ïõ®Ïù¥Ìä∏' },
            'BHD': { name: 'Î∞îÎ†àÏù∏ ÎîîÎÇòÎ•¥', nation: 'Î∞îÎ†àÏù∏' },
            'QAR': { name: 'Ïπ¥ÌÉÄÎ•¥ Î¶¨ÏñÑ', nation: 'Ïπ¥ÌÉÄÎ•¥' },
            'EGP': { name: 'Ïù¥ÏßëÌä∏ ÌååÏö¥Îìú', nation: 'Ïù¥ÏßëÌä∏' },
            'HUF': { name: 'ÌóùÍ∞ÄÎ¶¨ Ìè¨Î¶∞Ìä∏', nation: 'ÌóùÍ∞ÄÎ¶¨' },
            'DKK': { name: 'Îç¥ÎßàÌÅ¨ ÌÅ¨Î°úÎÑ§', nation: 'Îç¥ÎßàÌÅ¨' },
            'NOK': { name: 'ÎÖ∏Î•¥Ïõ®Ïù¥ ÌÅ¨Î°úÎÑ§', nation: 'ÎÖ∏Î•¥Ïõ®Ïù¥' },
            'ILS': { name: 'Ïù¥Ïä§ÎùºÏóò ÏÖ∞Ïºà', nation: 'Ïù¥Ïä§ÎùºÏóò' },
            'JOD': { name: 'ÏöîÎ•¥Îã® ÎîîÎÇòÎ•¥', nation: 'ÏöîÎ•¥Îã®' },
            'PKR': { name: 'ÌååÌÇ§Ïä§ÌÉÑ Î£®Ìîº', nation: 'ÌååÌÇ§Ïä§ÌÉÑ' },
            'BDT': { name: 'Î∞©Í∏ÄÎùºÎç∞Ïãú ÌÉÄÏπ¥', nation: 'Î∞©Í∏ÄÎùºÎç∞Ïãú' },
            'MNT': { name: 'Î™ΩÍ≥® Ìà¨Í∑∏Î¶≠', nation: 'Î™ΩÍ≥®' },
            'KZT': { name: 'Ïπ¥ÏûêÌùêÏä§ÌÉÑ ÌÖ°Í≤å', nation: 'Ïπ¥ÏûêÌùêÏä§ÌÉÑ' },
            'BND': { name: 'Î∏åÎ£®ÎÇòÏù¥ Îã¨Îü¨', nation: 'Î∏åÎ£®ÎÇòÏù¥' }
        };

        // ===================================
        // State & Elements
        // ===================================

        const state = {
            exchangeRates: {},
            currencyList: [],
            lastUpdated: null,
            selectedCurrency: 'USD',
            serviceChargeType: 'percent',
            isOptionsOpen: false,
            isSearchOpen: false
        };

        const elements = {
            currencyDisplay: document.getElementById('currencyDisplay'),
            selectedCurrencyText: document.getElementById('selectedCurrencyText'),
            currencySearchWrapper: document.getElementById('currencySearchWrapper'),
            currencySearchInput: document.getElementById('currencySearchInput'),
            closeSearchBtn: document.getElementById('closeSearchBtn'),
            currencyOptionsList: document.getElementById('currencyOptionsList'),
            currentRateDisplay: document.getElementById('currentRateDisplay'),
            detectLocationBtn: document.getElementById('detectLocationBtn'),
            localAmount: document.getElementById('localAmount'),
            currencySymbol: document.getElementById('currencySymbol'),
            optionsToggle: document.getElementById('optionsToggle'),
            optionsContent: document.getElementById('optionsContent'),
            toggleIcon: document.getElementById('toggleIcon'),
            serviceCharge: document.getElementById('serviceCharge'),
            serviceChargeUnit: document.getElementById('serviceChargeUnit'),
            tipPercentBtn: document.getElementById('tipPercentBtn'),
            tipFixedBtn: document.getElementById('tipFixedBtn'),
            taxRate: document.getElementById('taxRate'),
            feeRate: document.getElementById('feeRate'),
            resultValue: document.getElementById('resultValue'),
            resultBreakdown: document.getElementById('resultBreakdown'),
            refreshRateBtn: document.getElementById('refreshRateBtn'),
            rateUpdateTime: document.getElementById('rateUpdateTime')
        };

        // ===================================
        // Main Logic
        // ===================================

        async function fetchExchangeRates() {
            updateRateStatus('ÌôòÏú® Ï†ïÎ≥¥ Ïó∞Í≤∞ Ï§ë...');
            let success = false;

            // Check if we are running in file:// mode
            const isLocalFile = window.location.protocol === 'file:';

            // If local file, might fail CORS checks even with proxy due to null origin
            // We try anyway, but if it fails, we immediately fallback.

            for (const proxy of CONFIG.PROXIES) {
                try {
                    const url = proxy + encodeURIComponent(CONFIG.TARGET_URL);
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    let ratesData;
                    if (proxy.includes('allorigins') && !proxy.includes('raw')) {
                        const data = await response.json();
                        ratesData = JSON.parse(data.contents);
                    } else {
                        ratesData = await response.json();
                    }

                    if (!ratesData || !Array.isArray(ratesData)) throw new Error('Invalid data');

                    processExchangeData(ratesData);
                    state.lastUpdated = new Date();
                    updateRateStatus(`ÏóÖÎç∞Ïù¥Ìä∏: ${formatTime(state.lastUpdated)}`);
                    success = true;
                    break;
                } catch (e) {
                    console.warn(`Proxy ${proxy} failed:`, e);
                }
            }

            if (!success) {
                processExchangeData(FALLBACK_DATA);
                updateRateStatus('Ïò§ÌîÑÎùºÏù∏ Î™®Îìú (Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©)');
            }

            if (state.currencyList.length > 0) {
                renderCurrencyOptions(state.currencyList);
                selectCurrency(state.selectedCurrency);
            }
        }

        function processExchangeData(rawData) {
            state.exchangeRates = {};
            state.currencyList = [];
            const processedCodes = new Set();

            rawData.forEach(item => {
                if (!item.symbolCode || !item.calcPrice) return;
                const code = item.symbolCode;
                if (processedCodes.has(code)) return;

                let rate = parseFloat(item.calcPrice.replace(/,/g, ''));
                if (isNaN(rate)) return;

                let finalRate = rate;
                if (['JPY', 'VND', 'IDR'].includes(code)) {
                    finalRate = rate / 100;
                }

                const mapped = CURRENCY_NAMES[code] || {};
                const nationName = mapped.nation || item.stockExchangeType?.nationName || getCountryFromCode(code);
                const currencyName = mapped.name || item.name || code;

                const currencyObj = {
                    code: code,
                    name: currencyName,
                    nationName: nationName,
                    rate: finalRate,
                    displayRate: item.closePrice
                };
                state.exchangeRates[code] = currencyObj;
                state.currencyList.push(currencyObj);
                processedCodes.add(code);
            });

            const majors = ['USD', 'EUR', 'JPY', 'CNY', 'GBP', 'VND', 'IDR'];
            state.currencyList.sort((a, b) => {
                const idxA = majors.indexOf(a.code);
                const idxB = majors.indexOf(b.code);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return a.nationName.localeCompare(b.nationName);
            });
        }

        function renderCurrencyOptions(list) {
            elements.currencyOptionsList.innerHTML = '';
            if (list.length === 0) {
                elements.currencyOptionsList.innerHTML = '<div class="no-results">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
                return;
            }
            list.forEach(item => {
                const option = document.createElement('div');
                option.className = 'option-item';
                if (item.code === state.selectedCurrency) option.classList.add('selected');

                option.innerHTML = `
            <div class="option-info">
                <span class="option-name">${item.nationName}</span>
                <span class="option-code">(${item.code})</span>
            </div>
            ${item.code === state.selectedCurrency ? '<span style="color:var(--accent-primary)">‚úî</span>' : ''}
        `;
                option.addEventListener('click', () => selectCurrency(item.code));
                elements.currencyOptionsList.appendChild(option);
            });
        }

        function selectCurrency(code) {
            if (!state.exchangeRates[code]) return;
            state.selectedCurrency = code;
            const data = state.exchangeRates[code];

            elements.selectedCurrencyText.textContent = `${data.nationName} (${data.code})`;

            let rateText = formatNumber(data.rate, 2);
            if (['JPY', 'VND', 'IDR'].includes(code)) {
                elements.currentRateDisplay.textContent = `${data.displayRate} (100${code})`;
            } else {
                elements.currentRateDisplay.textContent = rateText;
            }

            elements.currencySymbol.textContent = getCurrencySymbol(code);

            if (state.serviceChargeType === 'fixed') {
                elements.serviceChargeUnit.textContent = getCurrencySymbol(code);
            }

            closeSearch();
            calculate();
        }

        function openSearch() {
            state.isSearchOpen = true;
            elements.currencyDisplay.style.display = 'none';
            elements.currencySearchWrapper.style.display = 'block';
            elements.currencySearchInput.value = '';
            renderCurrencyOptions(state.currencyList);
            elements.currencySearchInput.focus();
        }

        function closeSearch() {
            state.isSearchOpen = false;
            elements.currencySearchWrapper.style.display = 'none';
            elements.currencyDisplay.style.display = 'flex';
        }

        function filterCurrencyList(query) {
            const lowerQuery = query.toLowerCase();
            const filtered = state.currencyList.filter(item =>
                item.code.toLowerCase().includes(lowerQuery) ||
                item.name.toLowerCase().includes(lowerQuery) ||
                item.nationName.toLowerCase().includes(lowerQuery)
            );
            renderCurrencyOptions(filtered);
        }

        function handleNumberInput(e) {
            let value = e.target.value.replace(/[^0-9.]/g, '');
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            if (parts[0]) {
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
            const formatted = parts.join('.');
            if (e.target.value !== formatted) {
                e.target.value = formatted;
            }
            calculate();
        }

        function calculate() {
            const localAmount = parseFloat(elements.localAmount.value.replace(/,/g, '')) || 0;
            const serviceChargeInput = parseFloat(elements.serviceCharge.value.replace(/,/g, '')) || 0;
            const taxRate = parseFloat(elements.taxRate.value.replace(/,/g, '')) || 0;
            const feeRate = parseFloat(elements.feeRate.value.replace(/,/g, '')) || 0;

            if (!state.exchangeRates[state.selectedCurrency]) return;
            const exchangeRate = state.exchangeRates[state.selectedCurrency].rate;

            let serviceCharge = 0;
            if (state.serviceChargeType === 'percent') {
                serviceCharge = localAmount * (serviceChargeInput / 100);
            } else {
                serviceCharge = serviceChargeInput;
            }

            const withService = localAmount + serviceCharge;
            const withTax = withService * (1 + taxRate / 100);
            const withFee = withTax * (1 + feeRate / 100);
            const resultKRW = withFee * exchangeRate;

            elements.resultValue.textContent = formatNumber(Math.round(resultKRW));

            updateBreakdown({
                localAmount, serviceCharge, withService, taxRate,
                withTax, feeRate, withFee, exchangeRate, resultKRW
            });
        }

        function updateBreakdown(data) {
            const symbol = getCurrencySymbol(state.selectedCurrency);
            let html = '';
            if (data.localAmount > 0) {
                html = `
            <div class="breakdown-item"><span>Í∏∞Î≥∏ Í∏àÏï°</span><span>${symbol}${formatNumber(data.localAmount, 2)}</span></div>
        `;
                if (data.serviceCharge > 0) html += itemRow('+ ÏÑúÎπÑÏä§Ï∞®ÏßÄ', data.serviceCharge, symbol);
                if (data.taxRate > 0) html += itemRow(`+ ÏÑ∏Í∏à (${data.taxRate}%)`, data.withService * (data.taxRate / 100), symbol);
                if (data.feeRate > 0) html += itemRow(`+ ÏàòÏàòÎ£å (${data.feeRate}%)`, data.withTax * (data.feeRate / 100), symbol);
                html += `
            <div class="breakdown-item"><span>ÌòÑÏßÄ Ï¥ùÏï°</span><span>${symbol}${formatNumber(data.withFee, 2)}</span></div>
            <div class="breakdown-item breakdown-total"><span>ÏõêÌôî ÌôòÏÇ∞</span><span>‚Ç©${formatNumber(Math.round(data.resultKRW))}</span></div>
        `;
            }
            elements.resultBreakdown.innerHTML = html;
        }

        function itemRow(label, value, symbol) {
            return `<div class="breakdown-item"><span>${label}</span><span>${symbol}${formatNumber(value, 2)}</span></div>`;
        }

        function getCountryFromCode(currencyCode) {
            const map = { 'USD': 'ÎØ∏Íµ≠', 'KRW': 'ÌïúÍµ≠', 'EUR': 'Ïú†ÎüΩ', 'JPY': 'ÏùºÎ≥∏', 'CNY': 'Ï§ëÍµ≠' };
            return map[currencyCode] || currencyCode;
        }

        function getCurrencySymbol(code) {
            const symbols = {
                'USD': '$', 'EUR': '‚Ç¨', 'JPY': '¬•', 'CNY': '¬•', 'GBP': '¬£',
                'KRW': '‚Ç©', 'THB': '‡∏ø', 'VND': '‚Ç´', 'PHP': '‚Ç±', 'INR': '‚Çπ'
            };
            return symbols[code] || code;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatNumber(num, decimals = 0) {
            return num.toLocaleString('ko-KR', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function updateRateStatus(message) {
            elements.rateUpdateTime.textContent = message;
        }

        function initEventListeners() {
            elements.currencyDisplay.addEventListener('click', openSearch);
            elements.closeSearchBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeSearch();
            });
            elements.currencySearchInput.addEventListener('input', (e) => filterCurrencyList(e.target.value));

            document.addEventListener('click', (e) => {
                if (state.isSearchOpen &&
                    !elements.currencySearchWrapper.contains(e.target) &&
                    !elements.currencyDisplay.contains(e.target)) {
                    closeSearch();
                }
            });

            elements.localAmount.addEventListener('input', handleNumberInput);
            elements.serviceCharge.addEventListener('input', handleNumberInput);
            elements.taxRate.addEventListener('input', handleNumberInput);
            elements.feeRate.addEventListener('input', handleNumberInput);

            elements.optionsToggle.addEventListener('click', () => {
                state.isOptionsOpen = !state.isOptionsOpen;
                elements.optionsContent.classList.toggle('open', state.isOptionsOpen);
                elements.toggleIcon.classList.toggle('open', state.isOptionsOpen);
            });

            elements.tipPercentBtn.addEventListener('click', () => {
                state.serviceChargeType = 'percent';
                elements.tipPercentBtn.classList.add('active');
                elements.tipFixedBtn.classList.remove('active');
                elements.serviceChargeUnit.textContent = '%';
                calculate();
            });
            elements.tipFixedBtn.addEventListener('click', () => {
                state.serviceChargeType = 'fixed';
                elements.tipFixedBtn.classList.add('active');
                elements.tipPercentBtn.classList.remove('active');
                elements.serviceChargeUnit.textContent = getCurrencySymbol(state.selectedCurrency);
                calculate();
            });

            elements.refreshRateBtn.addEventListener('click', fetchExchangeRates);
            elements.detectLocationBtn.addEventListener('click', detectLocation);
        }

        async function detectLocation() {
            if (!navigator.geolocation) { alert('ÎØ∏ÏßÄÏõê'); return; }
            elements.detectLocationBtn.innerHTML = '<span>‚è≥ Í∞êÏßÄ Ï§ë...</span>';
            try {
                const position = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
                const { latitude, longitude } = position.coords;
                const res = await fetch(`${CONFIG.GEO_API}?latitude=${latitude}&longitude=${longitude}&localityLanguage=ko`);
                const data = await res.json();
                const countryCode = data.countryCode;
                const found = state.currencyList.find(c => c.code.startsWith(countryCode) || c.nationName === data.countryName);
                if (found) { selectCurrency(found.code); alert(`üìç ${data.countryName} Í∞êÏßÄ ÏôÑÎ£å`); }
                else { alert(`üìç ${data.countryName} Í∞êÏßÄÎê® (ÌôîÌèê Ï†ïÎ≥¥ ÏóÜÏùå)`); }
            } catch (e) {
                console.error(e);
                // Silent failure in offline mode usually to avoid annoying alerts, but here we show alert
                alert('ÏúÑÏπò Í∞êÏßÄ Ïã§Ìå® (Ïò§ÌîÑÎùºÏù∏Ïùº Ïàò ÏûàÏùå)');
            } finally {
                elements.detectLocationBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/>
            </svg><span>ÌòÑÏû¨ ÏúÑÏπòÎ°ú Ï∞æÍ∏∞</span>
        `;
            }
        }

        function init() {
            initEventListeners();
            fetchExchangeRates();
            setInterval(fetchExchangeRates, CONFIG.UPDATE_INTERVAL);
            calculate();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>