<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ì‹¤ì‹œê°„ í™˜ìœ¨ ê³„ì‚°ê¸° - í˜„ì§€ í™”íë¥¼ ëŒ€í•œë¯¼êµ­ ì›í™”ë¡œ ì¦‰ì‹œ ë³€í™˜">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>í™˜ìœ¨ ê³„ì‚°ê¸° | Currency Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
/* Base Styles Reset */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
}

:root {
    --bg-app: #0f172a;
    --bg-card: rgba(30, 41, 59, 0.7);
    --bg-input: rgba(15, 23, 42, 0.6);
    --accent-primary: #38dec8;
    --accent-secondary: #4f46e5;
    --accent-gradient: linear-gradient(135deg, #38dec8 0%, #4f46e5 100%);
    --text-primary: #f8fafc;
    --text-secondary: #94a3b8;
    --text-tertiary: #64748b;
    --border-color: rgba(148, 163, 184, 0.1);

    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;

    --font-size-xs: 12px;
    --font-size-sm: 14px;
    --font-size-md: 16px;
    --font-size-lg: 20px;
    --font-size-xl: 28px;
    --font-size-xxl: 36px;

    --radius-sm: 12px;
    --radius-md: 16px;
    --radius-lg: 24px;

    --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.2);
    --glass-blur: blur(12px);

    --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
    font-family: 'Inter', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: var(--bg-app);
    color: var(--text-primary);
    min-height: 100vh;
    min-height: 100dvh;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ===================================
   App Container
   =================================== */
.app-container {
    max-width: 480px;
    margin: 0 auto;
    min-height: 100vh;
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    padding: var(--spacing-md);
    padding-top: env(safe-area-inset-top, var(--spacing-md));
    padding-bottom: env(safe-area-inset-bottom, var(--spacing-md));
}

/* ===================================
   Header
   =================================== */
.app-header {
    text-align: center;
    padding: var(--spacing-lg) 0;
    margin-bottom: var(--spacing-md);
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-md);
}

.app-title {
    font-size: var(--font-size-xl);
    font-weight: 700;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.refresh-btn {
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: var(--spacing-sm);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}

@media (pointer: fine) {
    .refresh-btn:hover {
        background: var(--accent-primary);
        color: var(--text-primary);
        transform: rotate(180deg);
    }
}

.refresh-btn:active {
    transform: rotate(180deg) scale(0.95);
}

.rate-info {
    margin-top: var(--spacing-sm);
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

/* ===================================
   Calculator Main
   =================================== */
.calculator-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.section-label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-sm);
}

/* ===================================
   Currency Section
   =================================== */
.currency-section {
    background: var(--bg-card);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    box-shadow: var(--shadow-soft);
    margin-top: var(--spacing-lg);
    /* Fixed margin */
}

.currency-interaction-wrapper {
    position: relative;
    margin-bottom: var(--spacing-md);
}

.currency-display {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-md);
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.currency-display:hover {
    border-color: var(--accent-primary);
}

.display-text {
    font-weight: 600;
    font-size: var(--font-size-md);
}

.edit-hint {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

/* Search Input */
.currency-search-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 10;
    background: var(--bg-app);
    border-radius: var(--radius-sm);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--accent-primary);
}

.search-input-container {
    display: flex;
    align-items: center;
    padding: var(--spacing-xs);
    border-bottom: 1px solid var(--border-color);
}

.main-search-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    padding: var(--spacing-sm);
    font-size: var(--font-size-md);
    outline: none;
}

.close-search-btn {
    background: none;
    border: none;
    color: var(--text-tertiary);
    padding: var(--spacing-sm);
    cursor: pointer;
}

.dropdown-list {
    max-height: 200px;
    overflow-y: auto;
    background: var(--bg-card);
}

.option-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.option-item:hover,
.option-item.selected {
    background: rgba(56, 222, 200, 0.1);
}

.option-info {
    display: flex;
    flex-direction: column;
}

.option-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
}

.option-code {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

/* ===================================
   Amount Section
   =================================== */
.amount-section {
    position: relative;
}

.amount-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.currency-symbol {
    position: absolute;
    left: 0;
    font-size: var(--font-size-xl);
    font-weight: 300;
    color: var(--text-secondary);
    pointer-events: none;
}

.amount-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 2px solid var(--border-color);
    color: var(--text-primary);
    font-size: var(--font-size-xxl);
    font-weight: 700;
    padding: var(--spacing-sm) 30px var(--spacing-sm) var(--spacing-lg);
    /* Padding right for clear btn */
    text-align: right;
    outline: none;
    transition: all var(--transition-fast);
    border-radius: 0;
}

.amount-input:focus {
    border-bottom-color: var(--accent-primary);
}

/* ===================================
   Result Section
   =================================== */
.result-section {
    background: rgba(56, 222, 200, 0.05);
    border: 1px solid rgba(56, 222, 200, 0.2);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    text-align: right;
}

.result-label {
    font-size: var(--font-size-xs);
    color: var(--accent-primary);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: var(--spacing-xs);
}

.result-amount {
    display: flex;
    align-items: baseline;
    justify-content: flex-end;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
}

.result-symbol {
    font-size: var(--font-size-lg);
    color: var(--text-secondary);
}

.result-value {
    font-size: 36px;
    font-weight: 800;
    line-height: 1.1;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Breakdown */
.result-breakdown {
    border-top: 1px solid var(--border-color);
    padding-top: var(--spacing-md);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.breakdown-item {
    display: flex;
    justify-content: space-between;
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

.breakdown-total {
    margin-top: var(--spacing-xs);
    color: var(--text-primary);
    font-weight: 600;
}

/* ===================================
   Options Section
   =================================== */
.options-toggle {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    cursor: pointer;
    padding: 0;
    margin-bottom: var(--spacing-sm);
}

.toggle-icon {
    font-size: 10px;
    transition: transform var(--transition-fast);
}

.toggle-icon.open {
    transform: rotate(180deg);
}

.options-content {
    display: none;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    gap: var(--spacing-md);
    flex-direction: column;
    /* Updated layout */
}

.options-content.open {
    display: flex;
}

.option-group {
    display: flex;
    flex-direction: row;
    /* Horizontal layout */
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
}

.option-label {
    min-width: 80px;
    /* Fixed width labels align nicer */
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

.option-row {
    display: flex;
    gap: var(--spacing-sm);
}

.option-type-selector {
    display: flex;
    background: var(--bg-app);
    border-radius: var(--radius-sm);
    padding: 2px;
}

.type-btn {
    background: none;
    border: none;
    color: var(--text-tertiary);
    padding: 4px 8px;
    font-size: var(--font-size-xs);
    cursor: pointer;
    border-radius: 8px;
    transition: all var(--transition-fast);
}

.type-btn.active {
    background: var(--text-tertiary);
    color: var(--bg-app);
}

.option-input-wrapper {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    background: var(--bg-app);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 0 var(--spacing-sm);
}

.option-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    padding: 8px 24px 8px 0;
    /* Space for clear button */
    text-align: right;
    outline: none;
    width: 100%;
}

.option-unit {
    margin-left: var(--spacing-xs);
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

/* Clear Buttons */
.clear-btn {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: var(--text-tertiary);
    font-size: 16px;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}

.clear-btn.visible {
    opacity: 1;
    pointer-events: auto;
}

.option-clear {
    right: 20px;
    /* Adjust for unit */
}

/* ===================================
   Location & Footer
   =================================== */
.location-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    background: transparent;
    border: none;
    color: var(--accent-primary);
    font-size: var(--font-size-sm);
    padding: var(--spacing-sm);
    cursor: pointer;
    margin-bottom: 4px;
}

.current-rate {
    text-align: center;
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.rate-unit {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

.app-footer {
    margin-top: auto;
    text-align: center;
    padding-top: var(--spacing-lg);
    font-size: 11px;
    color: var(--text-tertiary);
    opacity: 0.7;
    padding-bottom: calc(env(safe-area-inset-bottom) + 32px);
}

.rate-info-footer {
    color: var(--accent-primary);
    margin-bottom: 4px;
}

/* Small Screen */
@media (max-width: 480px) and (max-height: 800px) {
    :root {
        --spacing-lg: 16px;
        --spacing-md: 12px;
        --font-size-xxl: 32px;
        --font-size-xl: 24px;
    }

    .app-header {
        padding: 12px 0;
        margin-bottom: 8px;
    }

    .calculator-main {
        gap: 16px;
    }

    .amount-input {
        font-size: 32px;
        padding: 4px 30px 4px 16px;
    }

    .result-section {
        padding: 16px;
    }

    .result-value {
        font-size: 36px;
    }

    .currency-section {
        padding: 12px;
    }

    .options-content {
        padding: 12px;
        gap: 8px;
    }

    .app-footer {
        padding-top: 12px;
    }
}
</style>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">ğŸ’± í™˜ìœ¨ ê³„ì‚°ê¸°</h1>
                <button id="refreshRateBtn" class="refresh-btn" aria-label="í™˜ìœ¨ ìƒˆë¡œê³ ì¹¨">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6" />
                        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" />
                    </svg>
                </button>
            </div>

        </header>

        <!-- Main Calculator Section -->
        <main class="calculator-main">
            <!-- Amount Input -->
            <section class="amount-section">
                <label for="localAmount" class="section-label">í˜„ì§€ ê¸ˆì•¡</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol" id="currencySymbol">$</span>
                    <input type="text" id="localAmount" class="amount-input" placeholder="0" inputmode="decimal"
                        autocomplete="off">
                    <button class="clear-btn" data-target="localAmount" aria-label="ì§€ìš°ê¸°">âœ•</button>
                </div>
            </section>

            <!-- Result Section (Placed prominently after input) -->
            <section class="result-section">
                <div class="result-label">ëŒ€í•œë¯¼êµ­ ì›í™”</div>
                <div class="result-amount">
                    <span class="result-symbol">â‚©</span>
                    <span class="result-value" id="resultValue">0</span>
                </div>
                <div class="result-breakdown" id="resultBreakdown">
                    <!-- Calculation breakdown will be inserted here -->
                </div>
            </section>

            <!-- Options Section (Collapsible) -->
            <section class="options-section">
                <button class="options-toggle" id="optionsToggle">
                    <span>ì¶”ê°€ ì˜µì…˜</span>
                    <span class="toggle-icon" id="toggleIcon">â–¼</span>
                </button>

                <div class="options-content" id="optionsContent">
                    <!-- Service Charge -->
                    <div class="option-group">
                        <label class="option-label">ì„œë¹„ìŠ¤ì°¨ì§€ (íŒ)</label>
                        <div class="option-row">
                            <div class="option-type-selector">
                                <button class="type-btn active" data-type="percent" id="tipPercentBtn">%</button>
                                <button class="type-btn" data-type="fixed" id="tipFixedBtn">ì •ì•¡</button>
                            </div>
                            <div class="option-input-wrapper">
                                <input type="text" id="serviceCharge" class="option-input" placeholder="0"
                                    inputmode="decimal" autocomplete="off">
                                <button class="clear-btn option-clear" data-target="serviceCharge"
                                    aria-label="ì§€ìš°ê¸°">âœ•</button>
                                <span class="option-unit" id="serviceChargeUnit">%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tax Rate -->
                    <div class="option-group">
                        <label class="option-label">ì„¸ê¸ˆìœ¨</label>
                        <div class="option-input-wrapper">
                            <input type="text" id="taxRate" class="option-input" placeholder="0" inputmode="decimal"
                                autocomplete="off">
                            <button class="clear-btn option-clear" data-target="taxRate" aria-label="ì§€ìš°ê¸°">âœ•</button>
                            <span class="option-unit">%</span>
                        </div>
                    </div>

                    <!-- Fee Rate -->
                    <div class="option-group">
                        <label class="option-label">ìˆ˜ìˆ˜ë£Œìœ¨</label>
                        <div class="option-input-wrapper">
                            <input type="text" id="feeRate" class="option-input" placeholder="0" inputmode="decimal"
                                autocomplete="off">
                            <button class="clear-btn option-clear" data-target="feeRate" aria-label="ì§€ìš°ê¸°">âœ•</button>
                            <span class="option-unit">%</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Currency Selection (Moved to bottom) -->
            <section class="currency-section">
                <div class="currency-selector">
                    <label class="section-label">í˜„ì§€ í™”í ë³€ê²½</label>
                    <div class="currency-interaction-wrapper">
                        <!-- Display Mode -->
                        <div id="currencyDisplay" class="currency-display" role="button" tabindex="0">
                            <span id="selectedCurrencyText" class="display-text">ë¯¸êµ­ (USD)</span>
                            <span class="edit-hint">âœ ë³€ê²½</span>
                        </div>

                        <!-- Input Mode -->
                        <div id="currencySearchWrapper" class="currency-search-wrapper" style="display: none;">
                            <div class="search-input-container">
                                <input type="text" id="currencySearchInput" class="main-search-input"
                                    placeholder="êµ­ê°€ëª… ë˜ëŠ” í™”íëª… ê²€ìƒ‰..." autocomplete="off">
                                <button id="closeSearchBtn" class="close-search-btn" aria-label="ë‹«ê¸°">âœ•</button>
                            </div>

                            <div class="dropdown-list" id="currencyOptionsList">
                                <!-- Options populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Moved 'detect location' inside here or right below -->
                    <button id="detectLocationBtn" class="location-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <circle cx="12" cy="12" r="3" />
                            <line x1="12" y1="2" x2="12" y2="6" />
                            <line x1="12" y1="18" x2="12" y2="22" />
                            <line x1="2" y1="12" x2="6" y2="12" />
                            <line x1="18" y1="12" x2="22" y2="12" />
                        </svg>
                        <span>í˜„ì¬ ìœ„ì¹˜ë¡œ ì°¾ê¸°</span>
                    </button>

                    <div class="current-rate" style="margin-top: 10px;">
                        <span>ì ìš© í™˜ìœ¨: </span>
                        <strong id="currentRateDisplay">-</strong>
                        <span class="rate-unit">ì›</span>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="rate-info-footer" id="rateUpdateTime" style="margin-bottom: 4px; font-weight: 500;">í™˜ìœ¨ ì •ë³´ ë¡œë”©
                ì¤‘...</div>
            <p id="sourceInfo">í™˜ìœ¨ ì •ë³´: Global Standard API</p>
            <p class="disclaimer">â€» ì‹¤ì œ í™˜ì „ ì‹œ í™˜ìœ¨ì€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        </footer>
    </div>

    <script>
/**
 * í™˜ìœ¨ ê³„ì‚°ê¸° ì•± - Currency Exchange Calculator
 * ëŒ€í•œë¯¼êµ­ ì›í™”(KRW) ê¸°ì¤€ ì‹¤ì‹œê°„ í™˜ìœ¨ ê³„ì‚°
 */

// ===================================
// Configuration & Constants
// ===================================

const CONFIG = {
    PROXIES: [
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url=',
        'https://thingproxy.freeboard.io/fetch/'
    ],
    // Swapped: Global Standard is now TARGET (Primary), Naver is BACKUP
    TARGET_URL: 'https://open.er-api.com/v6/latest/KRW',
    GEO_API: 'https://api.bigdatacloud.net/data/reverse-geocode-client',
    BACKUP_API: 'https://api.stock.naver.com/marketindex/exchanges', // Naver as Backup via Proxy
    UPDATE_INTERVAL: 0,
    CACHE_KEY: 'exchange_rates_cache_v2' // Version bump for new structure
};

const FALLBACK_DATA = [
    { "symbolCode": "USD", "name": "ë¯¸êµ­ USD", "stockExchangeType": { "nationCode": "USA", "nationName": "ë¯¸êµ­" }, "calcPrice": "1423.80", "closePrice": "1,423.80", "unit": "KRW" },
    { "symbolCode": "EUR", "name": "ìœ ëŸ½ EUR", "stockExchangeType": { "nationCode": "EU", "nationName": "ìœ ëŸ½ì—°í•©" }, "calcPrice": "1708.63", "closePrice": "1,708.63", "unit": "KRW" },
    { "symbolCode": "JPY", "name": "ì¼ë³¸ JPY (100ì—”)", "stockExchangeType": { "nationCode": "JPN", "nationName": "ì¼ë³¸" }, "calcPrice": "933.24", "closePrice": "933.24", "unit": "KRW" },
    { "symbolCode": "CNY", "name": "ì¤‘êµ­ CNY", "stockExchangeType": { "nationCode": "CHN", "nationName": "ì¤‘êµ­" }, "calcPrice": "205.21", "closePrice": "205.21", "unit": "KRW" },
    { "symbolCode": "HKD", "name": "í™ì½© HKD", "stockExchangeType": { "nationCode": "HKG", "nationName": "í™ì½©" }, "calcPrice": "182.50", "closePrice": "182.50", "unit": "KRW" },
    { "symbolCode": "TWD", "name": "ëŒ€ë§Œ TWD", "stockExchangeType": { "nationCode": "TWN", "nationName": "ëŒ€ë§Œ" }, "calcPrice": "44.80", "closePrice": "44.80", "unit": "KRW" },
    { "symbolCode": "GBP", "name": "ì˜êµ­ GBP", "stockExchangeType": { "nationCode": "GBR", "nationName": "ì˜êµ­" }, "calcPrice": "1800.50", "closePrice": "1,800.50", "unit": "KRW" },
    { "symbolCode": "CAD", "name": "ìºë‚˜ë‹¤ CAD", "stockExchangeType": { "nationCode": "CAN", "nationName": "ìºë‚˜ë‹¤" }, "calcPrice": "1050.20", "closePrice": "1,050.20", "unit": "KRW" },
    { "symbolCode": "CHF", "name": "ìŠ¤ìœ„ìŠ¤ CHF", "stockExchangeType": { "nationCode": "CHE", "nationName": "ìŠ¤ìœ„ìŠ¤" }, "calcPrice": "1580.40", "closePrice": "1,580.40", "unit": "KRW" },
    { "symbolCode": "AUD", "name": "í˜¸ì£¼ AUD", "stockExchangeType": { "nationCode": "AUS", "nationName": "í˜¸ì£¼" }, "calcPrice": "920.30", "closePrice": "920.30", "unit": "KRW" },
    { "symbolCode": "SGD", "name": "ì‹±ê°€í¬ë¥´ SGD", "stockExchangeType": { "nationCode": "SGP", "nationName": "ì‹±ê°€í¬ë¥´" }, "calcPrice": "1050.80", "closePrice": "1,050.80", "unit": "KRW" },
    { "symbolCode": "THB", "name": "íƒœêµ­ THB", "stockExchangeType": { "nationCode": "THA", "nationName": "íƒœêµ­" }, "calcPrice": "41.50", "closePrice": "41.50", "unit": "KRW" },
    { "symbolCode": "IDR", "name": "ì¸ë„ë„¤ì‹œì•„ IDR 100", "stockExchangeType": { "nationCode": "IDN", "nationName": "ì¸ë„ë„¤ì‹œì•„" }, "calcPrice": "9.00", "closePrice": "9.00", "unit": "KRW" },
    { "symbolCode": "VND", "name": "ë² íŠ¸ë‚¨ VND 100", "stockExchangeType": { "nationCode": "VNM", "nationName": "ë² íŠ¸ë‚¨" }, "calcPrice": "6.00", "closePrice": "6.00", "unit": "KRW" },
    { "symbolCode": "MYR", "name": "ë§ë ˆì´ì‹œì•„ MYR", "stockExchangeType": { "nationCode": "MYS", "nationName": "ë§ë ˆì´ì‹œì•„" }, "calcPrice": "318.50", "closePrice": "318.50", "unit": "KRW" },
    { "symbolCode": "PHP", "name": "í•„ë¦¬í•€ PHP", "stockExchangeType": { "nationCode": "PHL", "nationName": "í•„ë¦¬í•€" }, "calcPrice": "25.20", "closePrice": "25.20", "unit": "KRW" },
    { "symbolCode": "ZAR", "name": "ë‚¨ì•„ê³µ ZAR", "stockExchangeType": { "nationCode": "ZAF", "nationName": "ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­" }, "calcPrice": "78.50", "closePrice": "78.50", "unit": "KRW" },
    { "symbolCode": "RUB", "name": "ëŸ¬ì‹œì•„ RUB", "stockExchangeType": { "nationCode": "RUS", "nationName": "ëŸ¬ì‹œì•„" }, "calcPrice": "15.20", "closePrice": "15.20", "unit": "KRW" },
    { "symbolCode": "TRY", "name": "íŠ€ë¥´í‚¤ì˜ˆ TRY", "stockExchangeType": { "nationCode": "TUR", "nationName": "íŠ€ë¥´í‚¤ì˜ˆ" }, "calcPrice": "40.50", "closePrice": "40.50", "unit": "KRW" },
    { "symbolCode": "BRL", "name": "ë¸Œë¼ì§ˆ BRL", "stockExchangeType": { "nationCode": "BRA", "nationName": "ë¸Œë¼ì§ˆ" }, "calcPrice": "245.20", "closePrice": "245.20", "unit": "KRW" },
    { "symbolCode": "MXN", "name": "ë©•ì‹œì½” MXN", "stockExchangeType": { "nationCode": "MEX", "nationName": "ë©•ì‹œì½”" }, "calcPrice": "72.10", "closePrice": "72.10", "unit": "KRW" },
    { "symbolCode": "AED", "name": "UAE AED", "stockExchangeType": { "nationCode": "ARE", "nationName": "ì•„ëì—ë¯¸ë¦¬íŠ¸" }, "calcPrice": "387.60", "closePrice": "387.60", "unit": "KRW" },
    { "symbolCode": "INR", "name": "ì¸ë„ INR", "stockExchangeType": { "nationCode": "IND", "nationName": "ì¸ë„" }, "calcPrice": "16.80", "closePrice": "16.80", "unit": "KRW" },
    { "symbolCode": "SAR", "name": "ì‚¬ìš°ë”” SAR", "stockExchangeType": { "nationCode": "SAU", "nationName": "ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„" }, "calcPrice": "379.50", "closePrice": "379.50", "unit": "KRW" },
    { "symbolCode": "NZD", "name": "ë‰´ì§ˆëœë“œ NZD", "stockExchangeType": { "nationCode": "NZL", "nationName": "ë‰´ì§ˆëœë“œ" }, "calcPrice": "850.20", "closePrice": "850.20", "unit": "KRW" },
    { "symbolCode": "CZK", "name": "ì²´ì½” CZK", "stockExchangeType": { "nationCode": "CZE", "nationName": "ì²´ì½”" }, "calcPrice": "60.50", "closePrice": "60.50", "unit": "KRW" },
    { "symbolCode": "PLN", "name": "í´ë€ë“œ PLN", "stockExchangeType": { "nationCode": "POL", "nationName": "í´ë€ë“œ" }, "calcPrice": "355.40", "closePrice": "355.40", "unit": "KRW" },
    { "symbolCode": "HUF", "name": "í—ê°€ë¦¬ HUF", "stockExchangeType": { "nationCode": "HUN", "nationName": "í—ê°€ë¦¬" }, "calcPrice": "3.80", "closePrice": "3.80", "unit": "KRW" }
];

const CURRENCY_NAMES = {
    'USD': { name: 'ë¯¸êµ­ ë‹¬ëŸ¬', nation: 'ë¯¸êµ­' },
    'EUR': { name: 'ìœ ëŸ½ ìœ ë¡œ', nation: 'ìœ ëŸ½ì—°í•©' },
    'JPY': { name: 'ì¼ë³¸ ì—”', nation: 'ì¼ë³¸' },
    'CNY': { name: 'ì¤‘êµ­ ìœ„ì•ˆ', nation: 'ì¤‘êµ­' },
    'HKD': { name: 'í™ì½© ë‹¬ëŸ¬', nation: 'í™ì½©' },
    'TWD': { name: 'ëŒ€ë§Œ ë‹¬ëŸ¬', nation: 'ëŒ€ë§Œ' },
    'GBP': { name: 'ì˜êµ­ íŒŒìš´ë“œ', nation: 'ì˜êµ­' },
    'CAD': { name: 'ìºë‚˜ë‹¤ ë‹¬ëŸ¬', nation: 'ìºë‚˜ë‹¤' },
    'CHF': { name: 'ìŠ¤ìœ„ìŠ¤ í”„ë‘', nation: 'ìŠ¤ìœ„ìŠ¤' },
    'SEK': { name: 'ìŠ¤ì›¨ë´ í¬ë¡œë‚˜', nation: 'ìŠ¤ì›¨ë´' },
    'AUD': { name: 'í˜¸ì£¼ ë‹¬ëŸ¬', nation: 'í˜¸ì£¼' },
    'NZD': { name: 'ë‰´ì§ˆëœë“œ ë‹¬ëŸ¬', nation: 'ë‰´ì§ˆëœë“œ' },
    'CZK': { name: 'ì²´ì½” ì½”ë£¨ë‚˜', nation: 'ì²´ì½”' },
    'TRY': { name: 'íŠ€ë¥´í‚¤ì˜ˆ ë¦¬ë¼', nation: 'íŠ€ë¥´í‚¤ì˜ˆ' },
    'MXN': { name: 'ë©•ì‹œì½” í˜ì†Œ', nation: 'ë©•ì‹œì½”' },
    'PLN': { name: 'í´ë€ë“œ ì¦ˆì›Œí‹°', nation: 'í´ë€ë“œ' },
    'AED': { name: 'UAE ë””ë¥´í•¨', nation: 'ì•„ëì—ë¯¸ë¦¬íŠ¸' },
    'SGD': { name: 'ì‹±ê°€í¬ë¥´ ë‹¬ëŸ¬', nation: 'ì‹±ê°€í¬ë¥´' },
    'THB': { name: 'íƒœêµ­ ë°”íŠ¸', nation: 'íƒœêµ­' },
    'MYR': { name: 'ë§ë ˆì´ì‹œì•„ ë§ê¹ƒ', nation: 'ë§ë ˆì´ì‹œì•„' },
    'IDR': { name: 'ì¸ë„ë„¤ì‹œì•„ ë£¨í”¼ì•„', nation: 'ì¸ë„ë„¤ì‹œì•„' },
    'VND': { name: 'ë² íŠ¸ë‚¨ ë™', nation: 'ë² íŠ¸ë‚¨' },
    'PHP': { name: 'í•„ë¦¬í•€ í˜ì†Œ', nation: 'í•„ë¦¬í•€' },
    'RUB': { name: 'ëŸ¬ì‹œì•„ ë£¨ë¸”', nation: 'ëŸ¬ì‹œì•„' },
    'ZAR': { name: 'ë‚¨ì•„ê³µ ëœë“œ', nation: 'ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­' },
    'BRL': { name: 'ë¸Œë¼ì§ˆ ë ˆì•Œ', nation: 'ë¸Œë¼ì§ˆ' },
    'INR': { name: 'ì¸ë„ ë£¨í”¼', nation: 'ì¸ë„' },
    'SAR': { name: 'ì‚¬ìš°ë”” ë¦¬ì–„', nation: 'ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„' },
    'KWD': { name: 'ì¿ ì›¨ì´íŠ¸ ë””ë‚˜ë¥´', nation: 'ì¿ ì›¨ì´íŠ¸' },
    'BHD': { name: 'ë°”ë ˆì¸ ë””ë‚˜ë¥´', nation: 'ë°”ë ˆì¸' },
    'QAR': { name: 'ì¹´íƒ€ë¥´ ë¦¬ì–„', nation: 'ì¹´íƒ€ë¥´' },
    'EGP': { name: 'ì´ì§‘íŠ¸ íŒŒìš´ë“œ', nation: 'ì´ì§‘íŠ¸' },
    'HUF': { name: 'í—ê°€ë¦¬ í¬ë¦°íŠ¸', nation: 'í—ê°€ë¦¬' },
    'DKK': { name: 'ë´ë§ˆí¬ í¬ë¡œë„¤', nation: 'ë´ë§ˆí¬' },
    'NOK': { name: 'ë…¸ë¥´ì›¨ì´ í¬ë¡œë„¤', nation: 'ë…¸ë¥´ì›¨ì´' },
    'ILS': { name: 'ì´ìŠ¤ë¼ì—˜ ì…°ì¼ˆ', nation: 'ì´ìŠ¤ë¼ì—˜' },
    'JOD': { name: 'ìš”ë¥´ë‹¨ ë””ë‚˜ë¥´', nation: 'ìš”ë¥´ë‹¨' },
    'PKR': { name: 'íŒŒí‚¤ìŠ¤íƒ„ ë£¨í”¼', nation: 'íŒŒí‚¤ìŠ¤íƒ„' },
    'BDT': { name: 'ë°©ê¸€ë¼ë°ì‹œ íƒ€ì¹´', nation: 'ë°©ê¸€ë¼ë°ì‹œ' },
    'MNT': { name: 'ëª½ê³¨ íˆ¬ê·¸ë¦­', nation: 'ëª½ê³¨' },
    'KZT': { name: 'ì¹´ìíìŠ¤íƒ„ í…¡ê²Œ', nation: 'ì¹´ìíìŠ¤íƒ„' },
    'BND': { name: 'ë¸Œë£¨ë‚˜ì´ ë‹¬ëŸ¬', nation: 'ë¸Œë£¨ë‚˜ì´' }
};

// ===================================
// State & Elements
// ===================================

const state = {
    exchangeRates: {},
    currencyList: [],
    lastUpdated: null,
    selectedCurrency: 'USD',
    serviceChargeType: 'percent',
    isOptionsOpen: false,
    isOptionsOpen: false,
    isOptionsOpen: false,
    isSearchOpen: false,
    detectedTimeZone: null,
    // Option values are now persistent
    options: {
        serviceCharge: 0,
        taxRate: 0,
        feeRate: 0
    }
};

const elements = {
    currencyDisplay: document.getElementById('currencyDisplay'),
    selectedCurrencyText: document.getElementById('selectedCurrencyText'),
    currencySearchWrapper: document.getElementById('currencySearchWrapper'),
    currencySearchInput: document.getElementById('currencySearchInput'),
    closeSearchBtn: document.getElementById('closeSearchBtn'),
    currencyOptionsList: document.getElementById('currencyOptionsList'),
    currentRateDisplay: document.getElementById('currentRateDisplay'),
    detectLocationBtn: document.getElementById('detectLocationBtn'),
    localAmount: document.getElementById('localAmount'),
    currencySymbol: document.getElementById('currencySymbol'),
    optionsToggle: document.getElementById('optionsToggle'),
    optionsContent: document.getElementById('optionsContent'),
    toggleIcon: document.getElementById('toggleIcon'),
    serviceCharge: document.getElementById('serviceCharge'),
    serviceChargeUnit: document.getElementById('serviceChargeUnit'),
    tipPercentBtn: document.getElementById('tipPercentBtn'),
    tipFixedBtn: document.getElementById('tipFixedBtn'),
    taxRate: document.getElementById('taxRate'),
    feeRate: document.getElementById('feeRate'),
    resultValue: document.getElementById('resultValue'),
    resultBreakdown: document.getElementById('resultBreakdown'),
    refreshRateBtn: document.getElementById('refreshRateBtn'),
    rateUpdateTime: document.getElementById('rateUpdateTime')
};

// ===================================
// Main Logic
// ===================================

async function fetchExchangeRates(forceUpdate = false) {
    // 1. Smart Cache Check
    const cached = localStorage.getItem(CONFIG.CACHE_KEY);
    let nextUpdateUnix = 0;

    if (cached) {
        try {
            const { data, timestamp, source, nextUpdate } = JSON.parse(cached);

            // "If data to bring is same... don't bring."
            // Check nextUpdate time if available
            const now = new Date().getTime();
            if (nextUpdate && now < nextUpdate) {
                // Data is still valid according to API promise
                if (forceUpdate) {
                    // Force blur before alert to remove button state on mobile
                    if (document.activeElement) document.activeElement.blur();
                    setTimeout(() => {
                        alert('í˜„ì¬ ë°ì´í„°ê°€ ìµœì‹ ì…ë‹ˆë‹¤.\n(ë‹¤ìŒ ì—…ë°ì´íŠ¸: ' + formatTime(new Date(nextUpdate)) + ')');
                    }, 100); // Slight increase in delay to ensure blur renders
                }
                processData(data); // Use cached
                state.lastUpdated = new Date(timestamp);
                state.nextUpdate = nextUpdate; // Restore state
                updateSourceInfo(source);
                updateRateStatus(`ìµœì‹  ë°ì´í„° ìœ ì§€ ì¤‘ (${source}): ${formatTime(state.lastUpdated)}`);

                if (state.currencyList.length > 0) {
                    renderCurrencyOptions(state.currencyList);
                    selectCurrency(state.selectedCurrency);
                }
                return;
            }

            // If cache exists but might be old, use it initially if !forceUpdate
            if (!forceUpdate) {
                processData(data);
                state.lastUpdated = new Date(timestamp);
                updateSourceInfo(source);
                updateRateStatus(`ì €ì¥ëœ ë°ì´í„° (${source}): ${formatTime(state.lastUpdated)}`);
                if (state.currencyList.length > 0) {
                    renderCurrencyOptions(state.currencyList);
                    selectCurrency(state.selectedCurrency);
                }
                return;
            }
        } catch (e) {
            console.warn('Cache invalid', e);
            localStorage.removeItem(CONFIG.CACHE_KEY);
        }
    }

    updateRateStatus('í™˜ìœ¨ ì •ë³´ ì—°ê²° ì¤‘...');
    let success = false;
    let fetchedData = null;

    // Check if we are running in file:// mode
    const isLocalFile = window.location.protocol === 'file:';

    // 2. Try Proxies
    for (const proxy of CONFIG.PROXIES) {
        try {
            const url = proxy + encodeURIComponent(CONFIG.TARGET_URL);
            // Add timeout signal to fail fast
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout per proxy

            const response = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            let ratesData;
            // Handle different proxy response formats
            if (proxy.includes('allorigins') || proxy.includes('thingproxy')) {
                // Some proxies might return wrapped JSON or just raw. 
                // Thingproxy returns raw usually. Allorigins with 'raw' returns raw.
                // We kept 'raw' param in config for allorigins.
                ratesData = await response.json();
                // If wrapped in contents (standard allorigins without raw), handle it.
                if (ratesData.contents) ratesData = JSON.parse(ratesData.contents);
            } else {
                ratesData = await response.json();
            }

            if (!ratesData || (!Array.isArray(ratesData) && !ratesData.rates && ratesData.result !== 'success')) throw new Error('Invalid data');

            fetchedData = ratesData;
            processData(ratesData); // Changed from processExchangeData
            success = true;
            break;
        } catch (e) {
            console.warn(`Proxy ${proxy} failed:`, e);
        }
    }

    // 3. Backup API (Naver)
    if (!success) {
        try {
            const res = await fetch(CONFIG.BACKUP_API);
            if (res.ok) {
                const data = await res.json();
                fetchedData = data; // Store for caching
                processData(data); // Changed from processBackupData
                state.lastUpdated = new Date();
                // updateRateStatus(`ì—…ë°ì´íŠ¸ (Naver/Hana Bank): ${formatTime(state.lastUpdated)}`); // This will be handled by the common caching block
                success = true;
            }
        } catch (e) {
            console.warn('Backup failed:', e);
        }
    }

    // 4. Fallback (Offline hardcoded)
    if (!success) {
        processData(FALLBACK_DATA); // Changed from processExchangeData
        updateRateStatus('ì˜¤í”„ë¼ì¸ ëª¨ë“œ (ê¸°ë³¸ê°’ ì‚¬ìš©)');
    } else if (fetchedData) {
        state.lastUpdated = new Date();

        let finalSource = 'Unknown';
        let nextUpdate = 0;

        // determine source type
        if (Array.isArray(fetchedData)) {
            finalSource = 'Naver/Hana Bank';
            // Naver doesn't give next update, assume 1 hour? Or just 0.
        } else if (fetchedData.result === 'success' || fetchedData.rates) {
            finalSource = 'Global Standard API';
            if (fetchedData.time_next_update_unix) {
                nextUpdate = fetchedData.time_next_update_unix * 1000;
            }
        }

        updateSourceInfo(finalSource);
        updateRateStatus(`ì—…ë°ì´íŠ¸ (${finalSource}): ${formatTime(state.lastUpdated)}`);

        try {
            const cachePayload = {
                data: fetchedData,
                timestamp: state.lastUpdated.getTime(),
                source: finalSource,
                nextUpdate: nextUpdate
            };
            localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify(cachePayload));
        } catch (e) {
            console.warn('Cache write failed', e);
        }
    }

    if (state.currencyList.length > 0) {
        renderCurrencyOptions(state.currencyList);
        // Do not reset selection if it exists and valid
        if (!state.exchangeRates[state.selectedCurrency]) {
            selectCurrency('USD');
        } else {
            selectCurrency(state.selectedCurrency);
        }
    }
}

function processBackupData(data) {
    state.exchangeRates = {};
    state.currencyList = [];

    // ExchangeRate-API returns rates relative to base (KRW)
    // "rates": { "USD": 0.00075, ... } -> 1 KRW = 0.00075 USD
    // We need KRW per 1 Unit -> 1 / 0.00075

    const rates = data.rates || {};

    Object.keys(CURRENCY_NAMES).forEach(code => {
        const val = rates[code];
        if (val) {
            const rate = 1 / val;
            let displayRate = rate;

            // JPY, VND, IDR are typically shown per 100 units in UI, but logic uses per 1 unit
            if (['JPY', 'VND', 'IDR'].includes(code)) {
                displayRate = rate * 100;
            }

            const currencyObj = {
                code: code,
                name: CURRENCY_NAMES[code].name,
                nationName: CURRENCY_NAMES[code].nation,
                rate: rate,
                displayRate: formatNumber(displayRate, 2)
            };

            state.exchangeRates[code] = currencyObj;
            state.currencyList.push(currencyObj);
        }
    });

    const majors = ['USD', 'EUR', 'JPY', 'CNY', 'GBP', 'VND', 'IDR'];
    state.currencyList.sort((a, b) => {
        const idxA = majors.indexOf(a.code);
        const idxB = majors.indexOf(b.code);
        if (idxA !== -1 && idxB !== -1) return idxA - idxB;
        if (idxA !== -1) return -1;
        if (idxB !== -1) return 1;
        return a.nationName.localeCompare(b.nationName);
    });
}

function processData(data) {
    // Unify processing. Detect type.
    if (Array.isArray(data)) {
        processNaverData(data);
    } else if (data.rates || (data.result === 'success')) {
        processGlobalData(data);
    }
}

function updateSourceInfo(sourceName) {
    const footer = document.getElementById('sourceInfo');
    if (footer) {
        if (sourceName.includes('Naver')) {
            footer.innerHTML = 'í™˜ìœ¨ ì •ë³´: í•˜ë‚˜ì€í–‰ (Naver)';
        } else {
            footer.innerHTML = 'í™˜ìœ¨ ì •ë³´: Global Standard API (ExchangeRate-API)';
        }
    }
}

function processGlobalData(data) {
    state.exchangeRates = {};
    state.currencyList = [];

    const rates = data.rates || {};
    Object.keys(CURRENCY_NAMES).forEach(code => {
        const val = rates[code];
        if (val) {
            const rate = 1 / val;
            let displayRate = rate;
            if (['JPY', 'VND', 'IDR'].includes(code)) displayRate = rate * 100;

            const currencyObj = {
                code: code,
                name: CURRENCY_NAMES[code].name,
                nationName: CURRENCY_NAMES[code].nation,
                rate: rate,
                displayRate: formatNumber(displayRate, 2)
            };
            state.exchangeRates[code] = currencyObj;
            state.currencyList.push(currencyObj);
        }
    });
    sortCurrencyList();
}

function processNaverData(rawData) {
    state.exchangeRates = {};
    state.currencyList = [];
    const processedCodes = new Set();

    rawData.forEach(item => {
        if (!item.symbolCode || !item.calcPrice) return;
        const code = item.symbolCode;
        if (processedCodes.has(code)) return;

        let rate = parseFloat(item.calcPrice.replace(/,/g, ''));
        if (isNaN(rate)) return;

        let finalRate = rate;
        if (['JPY', 'VND', 'IDR'].includes(code)) finalRate = rate / 100;

        const mapped = CURRENCY_NAMES[code] || {};
        const nationName = mapped.nation || item.stockExchangeType?.nationName || getCountryFromCode(code);
        const currencyName = mapped.name || item.name || code;

        const currencyObj = {
            code: code,
            name: currencyName,
            nationName: nationName,
            rate: finalRate,
            displayRate: item.closePrice
        };
        state.exchangeRates[code] = currencyObj;
        state.currencyList.push(currencyObj);
        processedCodes.add(code);
    });
    sortCurrencyList();
}

function sortCurrencyList() {
    const majors = ['USD', 'EUR', 'JPY', 'CNY', 'GBP', 'VND', 'IDR'];
    state.currencyList.sort((a, b) => {
        const idxA = majors.indexOf(a.code);
        const idxB = majors.indexOf(b.code);
        if (idxA !== -1 && idxB !== -1) return idxA - idxB;
        if (idxA !== -1) return -1;
        if (idxB !== -1) return 1;
        return a.nationName.localeCompare(b.nationName);
    });
}

function renderCurrencyOptions(list) {
    elements.currencyOptionsList.innerHTML = '';
    if (list.length === 0) {
        elements.currencyOptionsList.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }
    list.forEach(item => {
        const option = document.createElement('div');
        option.className = 'option-item';
        if (item.code === state.selectedCurrency) option.classList.add('selected');

        option.innerHTML = `
            <div class="option-info">
                <span class="option-name">${item.nationName}</span>
                <span class="option-code">(${item.code})</span>
            </div>
            ${item.code === state.selectedCurrency ? '<span style="color:var(--accent-primary)">âœ”</span>' : ''}
        `;
        option.addEventListener('click', () => selectCurrency(item.code));
        elements.currencyOptionsList.appendChild(option);
    });
}

function selectCurrency(code) {
    if (!state.exchangeRates[code]) return;
    state.selectedCurrency = code;
    const data = state.exchangeRates[code];

    elements.selectedCurrencyText.textContent = `${data.nationName} (${data.code})`;

    let rateText = formatNumber(data.rate, 2);
    if (['JPY', 'VND', 'IDR'].includes(code)) {
        elements.currentRateDisplay.textContent = `${data.displayRate} (100${code})`;
    } else {
        elements.currentRateDisplay.textContent = rateText;
    }

    elements.currencySymbol.textContent = getCurrencySymbol(code);

    // Update unit for Fixed Tip if active
    if (state.serviceChargeType === 'fixed') {
        elements.serviceChargeUnit.textContent = getCurrencySymbol(code);
    }

    closeSearch();
    calculate();
}

// ===================================
// UI Interaction Logic
// ===================================

function openSearch() {
    state.isSearchOpen = true;
    elements.currencyDisplay.style.display = 'none';
    elements.currencySearchWrapper.style.display = 'block';
    elements.currencySearchInput.value = '';
    renderCurrencyOptions(state.currencyList);
    elements.currencySearchInput.focus();
}

function closeSearch() {
    state.isSearchOpen = false;
    elements.currencySearchWrapper.style.display = 'none';
    elements.currencyDisplay.style.display = 'flex';
}

function filterCurrencyList(query) {
    const lowerQuery = query.toLowerCase();
    const filtered = state.currencyList.filter(item =>
        item.code.toLowerCase().includes(lowerQuery) ||
        item.name.toLowerCase().includes(lowerQuery) ||
        item.nationName.toLowerCase().includes(lowerQuery)
    );
    renderCurrencyOptions(filtered);
}

// ===================================
// Helper: Input Handling (Commas)
// ===================================

function handleNumberInput(e) {
    let value = e.target.value.replace(/[^0-9.]/g, '');

    // Ensure only one dot
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }

    // Add commas to integer part
    if (parts[0]) {
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    const formatted = parts.join('.');
    if (e.target.value !== formatted) {
        e.target.value = formatted;
    }

    calculate();
}

// ===================================
// Calculations & Helpers
// ===================================

function calculate() {
    const localAmount = parseFloat(elements.localAmount.value.replace(/,/g, '')) || 0;
    const serviceChargeInput = parseFloat(elements.serviceCharge.value.replace(/,/g, '')) || 0;
    const taxRate = parseFloat(elements.taxRate.value.replace(/,/g, '')) || 0;
    const feeRate = parseFloat(elements.feeRate.value.replace(/,/g, '')) || 0;

    if (!state.exchangeRates[state.selectedCurrency]) return;
    const exchangeRate = state.exchangeRates[state.selectedCurrency].rate;

    let serviceCharge = 0;
    if (state.serviceChargeType === 'percent') {
        serviceCharge = localAmount * (serviceChargeInput / 100);
    } else {
        serviceCharge = serviceChargeInput;
    }

    const withService = localAmount + serviceCharge;
    const withTax = withService * (1 + taxRate / 100);
    const withFee = withTax * (1 + feeRate / 100);
    const resultKRW = withFee * exchangeRate;

    elements.resultValue.textContent = formatNumber(Math.round(resultKRW));

    updateBreakdown({
        localAmount, serviceCharge, withService, taxRate,
        withTax, feeRate, withFee, exchangeRate, resultKRW
    });
}

function updateBreakdown(data) {
    const symbol = getCurrencySymbol(state.selectedCurrency);
    let html = '';
    if (data.localAmount > 0) {
        html = `
            <div class="breakdown-item"><span>ê¸°ë³¸ ê¸ˆì•¡</span><span>${symbol}${formatNumber(data.localAmount, 2)}</span></div>
        `;
        if (data.serviceCharge > 0) html += itemRow('+ ì„œë¹„ìŠ¤ì°¨ì§€', data.serviceCharge, symbol);
        if (data.taxRate > 0) html += itemRow(`+ ì„¸ê¸ˆ (${data.taxRate}%)`, data.withService * (data.taxRate / 100), symbol);
        if (data.feeRate > 0) html += itemRow(`+ ìˆ˜ìˆ˜ë£Œ (${data.feeRate}%)`, data.withTax * (data.feeRate / 100), symbol);

        html += `
            <div class="breakdown-item"><span>í˜„ì§€ ì´ì•¡</span><span>${symbol}${formatNumber(data.withFee, 2)}</span></div>
        `;
    }
    elements.resultBreakdown.innerHTML = html;
}

function itemRow(label, value, symbol) {
    return `<div class="breakdown-item"><span>${label}</span><span>${symbol}${formatNumber(value, 2)}</span></div>`;
}

function getCountryFromCode(currencyCode) {
    const map = { 'USD': 'ë¯¸êµ­', 'KRW': 'í•œêµ­', 'EUR': 'ìœ ëŸ½', 'JPY': 'ì¼ë³¸', 'CNY': 'ì¤‘êµ­' };
    return map[currencyCode] || currencyCode;
}

function getCurrencySymbol(code) {
    const symbols = {
        'USD': '$', 'EUR': 'â‚¬', 'JPY': 'Â¥', 'CNY': 'Â¥', 'GBP': 'Â£',
        'KRW': 'â‚©', 'THB': 'à¸¿', 'VND': 'â‚«', 'PHP': 'â‚±', 'INR': 'â‚¹'
    };
    return symbols[code] || code;
}

function formatTime(date) {
    const options = {
        month: 'numeric',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    if (state.detectedTimeZone) {
        try {
            options.timeZone = state.detectedTimeZone;
        } catch (e) {
            console.warn('Invalid TimeZone:', state.detectedTimeZone);
        }
    }
    return date.toLocaleTimeString('ko-KR', options);
}

function formatNumber(num, decimals = 0) {
    return num.toLocaleString('ko-KR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

function updateRateStatus(message) {
    elements.rateUpdateTime.textContent = message;
}

// ===================================
// Initialization
// ===================================

function initEventListeners() {
    elements.currencyDisplay.addEventListener('click', openSearch);
    elements.closeSearchBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        closeSearch();
    });
    elements.currencySearchInput.addEventListener('input', (e) => filterCurrencyList(e.target.value));

    document.addEventListener('click', (e) => {
        if (state.isSearchOpen &&
            !elements.currencySearchWrapper.contains(e.target) &&
            !elements.currencyDisplay.contains(e.target)) {
            closeSearch();
        }
    });

    // Unified number input handler with Persistence
    elements.localAmount.addEventListener('input', (e) => {
        handleNumberInput(e);
        toggleClearBtn('localAmount', e.target.value);
    });

    ['serviceCharge', 'taxRate', 'feeRate'].forEach(id => {
        elements[id].addEventListener('input', (e) => {
            handleNumberInput(e);
            toggleClearBtn(id, e.target.value);
            saveOptions(); // Save on change
        });
    });

    // Clear Buttons
    document.querySelectorAll('.clear-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const targetId = btn.dataset.target;
            const input = document.getElementById(targetId);
            if (input) {
                input.value = '';
                toggleClearBtn(targetId, '');
                input.focus();
                calculate(); // Recalculate
                if (['serviceCharge', 'taxRate', 'feeRate'].includes(targetId)) {
                    saveOptions(); // Save clear state
                }
            }
        });
    });

    elements.optionsToggle.addEventListener('click', () => {
        state.isOptionsOpen = !state.isOptionsOpen;
        elements.optionsContent.classList.toggle('open', state.isOptionsOpen);
        elements.toggleIcon.classList.toggle('open', state.isOptionsOpen);
    });

    elements.tipPercentBtn.addEventListener('click', () => {
        state.serviceChargeType = 'percent';
        elements.tipPercentBtn.classList.add('active');
        elements.tipFixedBtn.classList.remove('active');
        elements.serviceChargeUnit.textContent = '%';
        calculate();
    });
    elements.tipFixedBtn.addEventListener('click', () => {
        state.serviceChargeType = 'fixed';
        elements.tipFixedBtn.classList.add('active');
        elements.tipPercentBtn.classList.remove('active');
        elements.serviceChargeUnit.textContent = getCurrencySymbol(state.selectedCurrency);
        calculate();
    });

    elements.refreshRateBtn.addEventListener('click', async () => {
        await fetchExchangeRates(true);
        elements.refreshRateBtn.blur();
    });
    elements.detectLocationBtn.addEventListener('click', () => detectLocation(true));
}

async function detectLocation(interactive = false) {
    if (!navigator.geolocation) {
        if (interactive) alert('ë¯¸ì§€ì› ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
        return;
    }

    if (interactive) elements.detectLocationBtn.innerHTML = '<span>â³ ê°ì§€ ì¤‘...</span>';

    try {
        const position = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout: 10000 }));
        const { latitude, longitude } = position.coords;
        const res = await fetch(`${CONFIG.GEO_API}?latitude=${latitude}&longitude=${longitude}&localityLanguage=ko`);
        const data = await res.json();

        // Extract TimeZone from informative block (look for "Area/City" pattern)
        if (data.localityInfo && data.localityInfo.informative) {
            const tzEntry = data.localityInfo.informative.find(i => i.name && i.name.includes('/') && !i.name.includes(' '));
            if (tzEntry) {
                state.detectedTimeZone = tzEntry.name;
            }
        }

        const countryCode = data.countryCode;
        const found = state.currencyList.find(c => c.code.startsWith(countryCode) || c.nationName === data.countryName);

        if (found) {
            selectCurrency(found.code);
            if (interactive) alert(`ğŸ“ ${data.countryName} ê°ì§€ ì™„ë£Œ`);
        } else {
            if (interactive) alert(`ğŸ“ ${data.countryName} ê°ì§€ë¨ (í™”í ì •ë³´ ì—†ìŒ)`);
        }
    } catch (e) {
        console.error(e);
        if (interactive) alert('ìœ„ì¹˜ ê°ì§€ ì‹¤íŒ¨');
    } finally {
        elements.detectLocationBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/>
            </svg><span>í˜„ì¬ ìœ„ì¹˜ë¡œ ì°¾ê¸°</span>
        `;
    }
}

function init() {
    initEventListeners();

    // User requested "Location First" flow to reduce perceived data usage (even if packet is same)
    // and to set context before fetching.
    updateRateStatus('ìœ„ì¹˜ ì •ë³´ í™•ì¸ ì¤‘...');

    // We try detectLocation first. If it fails or times out, we proceed.
    detectLocation(false).then(() => {
        // After location check, fetch data.
        // If location found, `selectedCurrency` might be updated.
        // Then fetchExchangeRates will use that selection.
        fetchExchangeRates(false);
    });

    // Load saved options
    loadOptions();

    if (CONFIG.UPDATE_INTERVAL > 0) {
        setInterval(() => fetchExchangeRates(true), CONFIG.UPDATE_INTERVAL);
    }
    // Initial calculate call might be empty if no rates yet, but UI structure initializes.
    calculate();

    // Initial Toggle check
    toggleClearBtn('localAmount', elements.localAmount.value);
    toggleClearBtn('serviceCharge', elements.serviceCharge.value);
    toggleClearBtn('taxRate', elements.taxRate.value);
    toggleClearBtn('feeRate', elements.feeRate.value);
}

function saveOptions() {
    const options = {
        serviceCharge: elements.serviceCharge.value,
        taxRate: elements.taxRate.value,
        feeRate: elements.feeRate.value,
        serviceChargeType: state.serviceChargeType
    };
    localStorage.setItem('currency_calculator_options', JSON.stringify(options));
}

function loadOptions() {
    const saved = localStorage.getItem('currency_calculator_options');
    if (saved) {
        try {
            const options = JSON.parse(saved);
            if (options.serviceCharge !== undefined) elements.serviceCharge.value = options.serviceCharge;
            if (options.taxRate !== undefined) elements.taxRate.value = options.taxRate;
            if (options.feeRate !== undefined) elements.feeRate.value = options.feeRate;
            if (options.serviceChargeType) {
                state.serviceChargeType = options.serviceChargeType;
                if (state.serviceChargeType === 'fixed') {
                    elements.tipFixedBtn.click();
                } else {
                    elements.tipPercentBtn.click();
                }
            }
        } catch (e) {
            console.warn('Options load failed', e);
        }
    }
}

function toggleClearBtn(id, value) {
    const btn = document.querySelector(`.clear-btn[data-target="${id}"]`);
    if (btn) {
        if (value && value.length > 0) {
            btn.classList.add('visible');
        } else {
            btn.classList.remove('visible');
        }
    }
}

document.addEventListener('DOMContentLoaded', init);

</script>
</body>

</html>
