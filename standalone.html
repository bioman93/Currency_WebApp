<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ïã§ÏãúÍ∞Ñ ÌôòÏú® Í≥ÑÏÇ∞Í∏∞ - ÌòÑÏßÄ ÌôîÌèêÎ•º ÎåÄÌïúÎØºÍµ≠ ÏõêÌôîÎ°ú Ï¶âÏãú Î≥ÄÌôò">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ÌôòÏú® Í≥ÑÏÇ∞Í∏∞ | Currency Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
/* Base Styles Reset */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
}

:root {
    --bg-app: #0f172a;
    --bg-card: rgba(30, 41, 59, 0.7);
    --bg-input: rgba(15, 23, 42, 0.6);
    --accent-primary: #38dec8;
    --accent-secondary: #4f46e5;
    --accent-gradient: linear-gradient(135deg, #38dec8 0%, #4f46e5 100%);
    --text-primary: #f8fafc;
    --text-secondary: #94a3b8;
    --text-tertiary: #64748b;
    --border-color: rgba(148, 163, 184, 0.1);

    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;

    --font-size-xs: 12px;
    --font-size-sm: 14px;
    --font-size-md: 16px;
    --font-size-lg: 20px;
    --font-size-xl: 28px;
    --font-size-xxl: 36px;

    --radius-sm: 12px;
    --radius-md: 16px;
    --radius-lg: 24px;

    --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.2);
    --glass-blur: blur(12px);

    --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
    font-family: 'Inter', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: var(--bg-app);
    color: var(--text-primary);
    height: 100%;
    height: 100dvh;
    overflow: hidden;
    /* Lock body scroll */
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ===================================
   App Container
   =================================== */
.app-container {
    max-width: 480px;
    margin: 0 auto;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 0;
    /* Remove padding (moved to internal) */
}

/* ===================================
   Header
   =================================== */
.app-header {
    text-align: center;
    padding: var(--spacing-lg) var(--spacing-md);
    /* Add padding */
    margin-bottom: var(--spacing-md);
    flex-shrink: 0;
}

.header-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-md);
}

.app-title {
    font-size: var(--font-size-xl);
    font-weight: 700;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.refresh-btn {
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: var(--spacing-sm);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}

@media (pointer: fine) {
    .refresh-btn:hover {
        background: var(--accent-primary);
        color: var(--text-primary);
        transform: rotate(180deg);
    }
}

.refresh-btn:active {
    transform: rotate(180deg) scale(0.95);
}

.rate-info {
    margin-top: var(--spacing-sm);
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

/* ===================================
   Calculator Main
   =================================== */
.calculator-main {
    flex: 1;
    overflow-y: auto;
    /* Internal Scroll */
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
    padding: var(--spacing-md);
    /* Internal padding */
    padding-top: 0;
    -ms-overflow-style: none;
    /* Hide scrollbar */
    scrollbar-width: none;
}

.calculator-main::-webkit-scrollbar {
    display: none;
}

.section-label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-sm);
}

/* ===================================
   Currency Section
   =================================== */
.currency-section {
    background: var(--bg-card);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    box-shadow: var(--shadow-soft);
    margin-top: var(--spacing-lg);
    /* Fixed margin */
}

.currency-interaction-wrapper {
    position: relative;
    margin-bottom: var(--spacing-md);
}

.currency-display {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-md);
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.currency-display:hover {
    border-color: var(--accent-primary);
}

.display-text {
    font-weight: 600;
    font-size: var(--font-size-md);
}

.edit-hint {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

/* Search Input */
.currency-search-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 10;
    background: var(--bg-app);
    border-radius: var(--radius-sm);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--accent-primary);
}

.search-input-container {
    display: flex;
    align-items: center;
    padding: var(--spacing-xs);
    border-bottom: 1px solid var(--border-color);
}

.main-search-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    padding: var(--spacing-sm);
    font-size: var(--font-size-md);
    outline: none;
}

.close-search-btn {
    background: none;
    border: none;
    color: var(--text-tertiary);
    padding: var(--spacing-sm);
    cursor: pointer;
}

.dropdown-list {
    max-height: 200px;
    overflow-y: auto;
    background: var(--bg-card);
}

.option-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.option-item:hover,
.option-item.selected {
    background: rgba(56, 222, 200, 0.1);
}

.option-info {
    display: flex;
    flex-direction: column;
}

.option-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
}

.option-code {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

/* ===================================
   Amount Section
   =================================== */
.amount-section {
    position: relative;
}

/* ===================================
   Camera Section (Mobile Only)
   =================================== */
.camera-section {
    display: none;
    /* Hidden by default (PC) */
    margin-top: var(--spacing-md);
}

/* Show only on mobile/touch devices */
@media (pointer: coarse) and (max-width: 768px) {
    .camera-section {
        display: block;
    }
}

.camera-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: linear-gradient(135deg, rgba(56, 222, 200, 0.15) 0%, rgba(79, 70, 229, 0.15) 100%);
    border: 1px dashed var(--accent-primary);
    border-radius: var(--radius-sm);
    color: var(--accent-primary);
    font-size: var(--font-size-md);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.camera-btn:hover {
    background: linear-gradient(135deg, rgba(56, 222, 200, 0.25) 0%, rgba(79, 70, 229, 0.25) 100%);
    border-style: solid;
}

.camera-btn:active {
    transform: scale(0.98);
}

.camera-btn svg {
    flex-shrink: 0;
}

/* OCR Result Area */
.ocr-result {
    margin-top: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-color);
}

.ocr-status {
    text-align: center;
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    margin-bottom: var(--spacing-sm);
}

.ocr-status.loading::after {
    content: '';
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-left: 8px;
    border: 2px solid var(--accent-primary);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.ocr-prices {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
}

.ocr-price-item {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.ocr-price-item:hover {
    border-color: var(--accent-primary);
    background: rgba(56, 222, 200, 0.1);
}

.amount-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.currency-symbol {
    position: absolute;
    left: 0;
    font-size: var(--font-size-xl);
    font-weight: 300;
    color: var(--text-secondary);
    pointer-events: none;
}

.amount-input {
    width: 100%;
    background: transparent;
    border: none;
    border-bottom: 2px solid var(--border-color);
    color: var(--text-primary);
    font-size: var(--font-size-xxl);
    font-weight: 700;
    padding: var(--spacing-sm) 30px var(--spacing-sm) var(--spacing-lg);
    /* Padding right for clear btn */
    text-align: right;
    outline: none;
    transition: all var(--transition-fast);
    border-radius: 0;
}

.amount-input:focus {
    border-bottom-color: var(--accent-primary);
}

/* ===================================
   Result Section
   =================================== */
.result-section {
    background: rgba(56, 222, 200, 0.05);
    border: 1px solid rgba(56, 222, 200, 0.2);
    border-radius: var(--radius-md);
    padding: var(--spacing-lg);
    text-align: right;
}

.result-label {
    font-size: var(--font-size-xs);
    color: var(--accent-primary);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: var(--spacing-xs);
}

.result-amount {
    display: flex;
    align-items: baseline;
    justify-content: flex-end;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
}

.result-symbol {
    font-size: var(--font-size-lg);
    color: var(--text-secondary);
}

.result-value {
    font-size: 36px;
    font-weight: 800;
    line-height: 1.1;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Breakdown */
.result-breakdown {
    border-top: 1px solid var(--border-color);
    padding-top: var(--spacing-md);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.breakdown-item {
    display: flex;
    justify-content: space-between;
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

.breakdown-total {
    margin-top: var(--spacing-xs);
    color: var(--text-primary);
    font-weight: 600;
}

/* ===================================
   Options Section
   =================================== */
.options-toggle {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    cursor: pointer;
    padding: 0;
    margin-bottom: var(--spacing-sm);
}

.toggle-icon {
    font-size: 10px;
    transition: transform var(--transition-fast);
}

.toggle-icon.open {
    transform: rotate(180deg);
}

.options-content {
    display: none;
    background: var(--bg-input);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    gap: var(--spacing-md);
    flex-direction: column;
    /* Updated layout */
}

.options-content.open {
    display: flex;
}

.option-group {
    display: flex;
    flex-direction: row;
    /* Horizontal layout */
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
}

.option-label {
    min-width: 80px;
    /* Fixed width labels align nicer */
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

.option-row {
    display: flex;
    gap: var(--spacing-sm);
}

.option-type-selector {
    display: flex;
    background: var(--bg-app);
    border-radius: var(--radius-sm);
    padding: 2px;
}

.type-btn {
    background: none;
    border: none;
    color: var(--text-tertiary);
    padding: 4px 8px;
    font-size: var(--font-size-xs);
    cursor: pointer;
    border-radius: 8px;
    transition: all var(--transition-fast);
}

.type-btn.active {
    background: var(--text-tertiary);
    color: var(--bg-app);
}

.option-input-wrapper {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    background: var(--bg-app);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    padding: 0 var(--spacing-sm);
}

.option-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    padding: 8px 0;
    text-align: right;
    outline: none;
    width: 100%;
}

.option-unit {
    margin-left: var(--spacing-xs);
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

/* Clear Buttons */
.clear-btn {
    /* Position Reset */
    position: static;
    transform: none;

    background: rgba(56, 222, 200, 0.2);
    /* Visible Greenish Tint */
    border: 1px solid rgba(56, 222, 200, 0.3);
    color: var(--accent-primary);
    font-size: 12px;
    font-weight: 700;
    width: 24px;
    height: 24px;
    border-radius: 6px;
    /* Rounded Square */

    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;

    margin-left: var(--spacing-sm);
    flex-shrink: 0;

    /* Visibility Logic */
    visibility: hidden;
    opacity: 0;
    transition: all 0.2s;
}

.clear-btn:hover {
    background: rgba(56, 222, 200, 0.4);
}

.clear-btn.visible {
    visibility: visible;
    opacity: 1;
}

.option-clear {
    right: auto;
    /* Reset */
}

.option-clear {
    right: 20px;
    /* Adjust for unit */
}

/* ===================================
   Location & Footer
   =================================== */
.location-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    background: transparent;
    border: none;
    color: var(--accent-primary);
    font-size: var(--font-size-sm);
    padding: var(--spacing-sm);
    cursor: pointer;
    margin-bottom: 4px;
}

.current-rate {
    text-align: center;
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.rate-unit {
    font-size: var(--font-size-xs);
    color: var(--text-tertiary);
}

.app-footer {
    flex-shrink: 0;
    margin-top: 0;
    /* Remove auto margin */
    text-align: center;
    font-size: 11px;
    color: var(--text-tertiary);
    opacity: 0.7;
    padding: var(--spacing-md);
    padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
    background: var(--bg-app);
    z-index: 5;
}

.rate-info-footer {
    color: var(--accent-primary);
    margin-bottom: 4px;
}

/* Small Screen */
@media (max-width: 480px) and (max-height: 800px) {
    :root {
        --spacing-lg: 16px;
        --spacing-md: 12px;
        --font-size-xxl: 32px;
        --font-size-xl: 24px;
    }

    .app-header {
        padding: 12px 0;
        margin-bottom: 8px;
    }

    .calculator-main {
        gap: 16px;
    }

    .amount-input {
        font-size: 32px;
        padding: 4px 30px 4px 16px;
    }

    .result-section {
        padding: 16px;
    }

    .result-value {
        font-size: 36px;
    }

    .currency-section {
        padding: 12px;
    }

    .options-content {
        padding: 12px;
        gap: 8px;
    }

    .app-footer {
        padding-top: 12px;
    }
}

/* Fix for mobile dropdown transparency */
.currency-search-wrapper {
    background: var(--bg-app);
    z-index: 100;
    position: relative;
    border-radius: var(--radius-sm);
    /* Ensure it overlays correctly */
    display: none;
    flex: 1;
    overflow-y: auto;
}

/* Result Label Clickable (Foreigner Mode) */
#resultLabel {
    cursor: pointer;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 4px;
    transition: color 0.2s;
}

#resultLabel:hover {
    color: var(--accent-primary);
}


/* Enhanced Touch Target for Result Section */
.result-amount {
    cursor: pointer;
}

.result-label {
    padding: 10px 0;
    /* Increase touch area */
}


/* Feedack for Result Touch */
#resultAmount {
    cursor: pointer;
    padding: 10px 0;
    transition: opacity 0.2s;
}

#resultAmount:active,
#resultLabel:active {
    opacity: 0.7;
}


/* Target Search UI Overlay (Embedded) */
#resultSection {
    position: relative;
    overflow: hidden;
    /* Ensure list stays inside rounded corners */
}

.target-search-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* Cover entire result section */
    z-index: 20;
    background: var(--bg-card);
    /* Match card background */
    display: none;
    flex-direction: column;
    /* No border or shadow to feel 'inside' the card */
}

.target-search-overlay .dropdown-list {
    flex: 1;
    overflow-y: auto;
    background: transparent;
    /* Seamless list */
}

.target-search-overlay .search-input-container {
    border-bottom: 1px solid var(--border-color);
    padding: var(--spacing-xs);
}
</style>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Login UI Styles */
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-profile {
            display: none;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .camera-locked-message {
            text-align: center;
            padding: 15px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-top: 10px;
            font-size: 0.9rem;
            display: none;
            /* Initially hidden */
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">üí± ÌôòÏú® Í≥ÑÏÇ∞Í∏∞</h1>

                <div class="header-right">
                    <!-- Receipt Manager Button -->
                    <button id="receiptManagerBtn" class="icon-btn" aria-label="ÏòÅÏàòÏ¶ù Í¥ÄÎ¶¨" style="display:none;">
                        <span style="font-size: 1.2rem;">üßæ</span>
                    </button>

                    <!-- User Profile (Hidden by default) -->
                    <div id="userProfile" class="user-profile">
                        <img id="userAvatar" class="user-avatar" src="" alt="Profile">
                        <span id="userName">User</span>
                        <!-- SignOut moved directly here -->
                        <button id="signOutBtn" class="icon-btn" aria-label="Î°úÍ∑∏ÏïÑÏõÉ">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Google Sign-In Button -->
                    <div id="g_id_onload"
                        data-client_id="708082750675-162qtq9rpl4g5t6247dr87joitbksaua.apps.googleusercontent.com"
                        data-callback="handleCredentialResponse" data-auto_select="false" data-itp_support="true">
                    </div>
                    <div class="g_id_signin" data-type="icon" data-shape="circle" data-theme="outline"
                        data-text="signin_with" data-size="medium">
                    </div>

                    <button id="refreshRateBtn" class="refresh-btn" aria-label="ÌôòÏú® ÏÉàÎ°úÍ≥†Ïπ®">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6" />
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Calculator Section -->
        <main class="calculator-main">
            <!-- Amount Input -->
            <section class="amount-section">
                <label for="localAmount" class="section-label">ÌòÑÏßÄ Í∏àÏï°</label>
                <div class="amount-input-wrapper">
                    <span class="currency-symbol" id="currencySymbol">$</span>
                    <input type="text" id="localAmount" class="amount-input" placeholder="0" inputmode="decimal"
                        autocomplete="off">
                    <button class="clear-btn" data-target="localAmount" aria-label="ÏßÄÏö∞Í∏∞">C</button>
                </div>

                <!-- Camera Section (Mobile Only) -->
                <div class="camera-section" id="cameraSection" style="display: none;">
                    <button class="camera-btn" id="cameraBtn" aria-label="Í∞ÄÍ≤©Ìëú Ï¥¨ÏòÅ">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="6" width="18" height="14" rx="2" />
                            <circle cx="12" cy="13" r="4" />
                            <path d="M7 6V4a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v2" />
                        </svg>
                        <span>üì∏ Í∞ÄÍ≤©Ìëú Ï¥¨ÏòÅ (AI)</span>
                    </button>
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                </div>

                <div id="cameraLockedMsg" class="camera-locked-message">
                    <p>üì∏ Í∞ÄÍ≤©Ìëú ÏûêÎèô Ïù∏Ïãù</p>
                    <small>Î°úÍ∑∏Ïù∏ÌïòÎ©¥ AIÍ∞Ä Í∞ÄÍ≤©ÏùÑ ÏùΩÏñ¥Ï§çÎãàÎã§</small>
                </div>


                <!-- OCR Result Preview -->
                <div class="ocr-result" id="ocrResult" style="display:none;">
                    <div class="ocr-status" id="ocrStatus">Ïù∏Ïãù Ï§ë...</div>
                    <div class="ocr-prices" id="ocrPrices"></div>
                </div>
            </section>

            <!-- Result Section (Placed prominently after input) -->
            <section class="result-section" id="resultSection">
                <div class="result-label" id="resultLabel">ÎåÄÌïúÎØºÍµ≠ ÏõêÌôî (KRW)</div>
                <div class="result-amount" id="resultAmount">
                    <span class="result-symbol" id="resultSymbol">‚Ç©</span>
                    <span class="result-value" id="resultValue">0</span>
                </div>
                <div class="result-breakdown" id="resultBreakdown">
                    <!-- Calculation breakdown will be inserted here -->
                </div>

                <!-- Target Currency Search (Separate UI) -->
                <div id="targetSearchWrapper" class="target-search-overlay" style="display: none;">
                    <div class="search-input-container">
                        <input type="text" id="targetSearchInput" class="main-search-input" placeholder="ÎÇ¥ ÌôîÌèê(Íµ≠Ï†Å) Í≤ÄÏÉâ"
                            autocomplete="off">
                        <button id="targetCloseBtn" class="close-search-btn" aria-label="Îã´Í∏∞">‚úï</button>
                    </div>

                    <div class="dropdown-list" id="targetOptionsList">
                        <!-- Options populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Options Section (Collapsible) -->
            <section class="options-section">
                <button class="options-toggle" id="optionsToggle">
                    <span>Ï∂îÍ∞Ä ÏòµÏÖò</span>
                    <span class="toggle-icon" id="toggleIcon">‚ñº</span>
                </button>

                <div class="options-content" id="optionsContent">
                    <!-- Service Charge -->
                    <div class="option-group">
                        <label class="option-label">ÏÑúÎπÑÏä§Ï∞®ÏßÄ (ÌåÅ)</label>
                        <div class="option-row">
                            <div class="option-type-selector">
                                <button class="type-btn active" data-type="percent" id="tipPercentBtn">%</button>
                                <button class="type-btn" data-type="fixed" id="tipFixedBtn">Ï†ïÏï°</button>
                                <button class="type-btn" data-type="total" id="tipTotalBtn">Ìï©ÏÇ∞</button>
                            </div>
                            <div class="option-input-wrapper">
                                <input type="text" id="serviceCharge" class="option-input" placeholder="0"
                                    inputmode="decimal" autocomplete="off">
                                <span class="option-unit" id="serviceChargeUnit">%</span>
                                <button class="clear-btn option-clear" data-target="serviceCharge"
                                    aria-label="ÏßÄÏö∞Í∏∞">C</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tax Rate -->
                    <div class="option-group">
                        <label class="option-label">ÏÑ∏Í∏àÏú®</label>
                        <div class="option-input-wrapper">
                            <input type="text" id="taxRate" class="option-input" placeholder="0" inputmode="decimal"
                                autocomplete="off">
                            <span class="option-unit">%</span>
                            <button class="clear-btn option-clear" data-target="taxRate" aria-label="ÏßÄÏö∞Í∏∞">C</button>
                        </div>
                    </div>

                    <!-- Fee Rate -->
                    <div class="option-group">
                        <label class="option-label">ÏàòÏàòÎ£åÏú®</label>
                        <div class="option-input-wrapper">
                            <input type="text" id="feeRate" class="option-input" placeholder="0" inputmode="decimal"
                                autocomplete="off">
                            <span class="option-unit">%</span>
                            <button class="clear-btn option-clear" data-target="feeRate" aria-label="ÏßÄÏö∞Í∏∞">C</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Currency Selection (Moved to bottom) -->
            <section class="currency-section">
                <div class="currency-selector">
                    <label class="section-label">ÌòÑÏßÄ ÌôîÌèê Î≥ÄÍ≤Ω</label>
                    <div class="currency-interaction-wrapper">
                        <!-- Display Mode -->
                        <div id="currencyDisplay" class="currency-display" role="button" tabindex="0">
                            <span id="selectedCurrencyText" class="display-text">ÎØ∏Íµ≠ (USD)</span>
                            <span class="edit-hint">‚úé Î≥ÄÍ≤Ω</span>
                        </div>

                        <!-- Input Mode -->
                        <div id="currencySearchWrapper" class="currency-search-wrapper" style="display: none;">
                            <div class="search-input-container">
                                <input type="text" id="currencySearchInput" class="main-search-input"
                                    placeholder="Íµ≠Í∞ÄÎ™Ö ÎòêÎäî ÌôîÌèêÎ™Ö Í≤ÄÏÉâ..." autocomplete="off">
                                <button id="closeSearchBtn" class="close-search-btn" aria-label="Îã´Í∏∞">‚úï</button>
                            </div>

                            <div class="dropdown-list" id="currencyOptionsList">
                                <!-- Options populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Moved 'detect location' inside here or right below -->
                    <button id="detectLocationBtn" class="location-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <path
                                d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                        </svg>
                        <span>üåç ÌÉÄÏûÑÏ°¥ÏúºÎ°ú ÌôîÌèê Í∞êÏßÄ</span>
                    </button>

                    <div class="current-rate" style="margin-top: 10px;">
                        <span>Ï†ÅÏö© ÌôòÏú®: </span>
                        <strong id="currentRateDisplay">-</strong>
                        <span class="rate-unit">Ïõê</span>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="rate-info-footer" id="rateUpdateTime" style="margin-bottom: 4px; font-weight: 500;">ÌôòÏú® Ï†ïÎ≥¥ Î°úÎî©
                Ï§ë...</div>
            <p id="sourceInfo">ÌôòÏú® Ï†ïÎ≥¥: Global Standard API</p>
            <p class="disclaimer">‚Äª Ïã§Ï†ú ÌôòÏ†Ñ Ïãú ÌôòÏú®ÏùÄ Îã§Î•º Ïàò ÏûàÏäµÎãàÎã§</p>
        </footer>
    </div>

    <script>
/**
 * ÌôòÏú® Í≥ÑÏÇ∞Í∏∞ Ïï± - Currency Exchange Calculator
 * ÎåÄÌïúÎØºÍµ≠ ÏõêÌôî(KRW) Í∏∞Ï§Ä Ïã§ÏãúÍ∞Ñ ÌôòÏú® Í≥ÑÏÇ∞
 */

// ===================================
// Configuration & Constants
// ===================================

const CONFIG = {
    PROXIES: [
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url=',
        'https://thingproxy.freeboard.io/fetch/'
    ],
    TARGET_URL: 'https://open.er-api.com/v6/latest/KRW',
    BACKUP_API: 'https://api.stock.naver.com/marketindex/exchanges',
    APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxHQoBuTpCGUVbsqsR7n7i8lGw5SS35eGg1ptJlmPkGI5oXwQ_fyk5sJcdVShct24kA/exec',
    UPDATE_INTERVAL: 0,
    CACHE_KEY: 'exchange_rates_cache_v2'
};

const FALLBACK_DATA = [
    { "symbolCode": "USD", "name": "ÎØ∏Íµ≠ USD", "stockExchangeType": { "nationCode": "USA", "nationName": "ÎØ∏Íµ≠" }, "calcPrice": "1423.80", "closePrice": "1,423.80", "unit": "KRW" },
    { "symbolCode": "EUR", "name": "Ïú†ÎüΩ EUR", "stockExchangeType": { "nationCode": "EU", "nationName": "Ïú†ÎüΩÏó∞Ìï©" }, "calcPrice": "1708.63", "closePrice": "1,708.63", "unit": "KRW" },
    { "symbolCode": "JPY", "name": "ÏùºÎ≥∏ JPY (100Ïóî)", "stockExchangeType": { "nationCode": "JPN", "nationName": "ÏùºÎ≥∏" }, "calcPrice": "933.24", "closePrice": "933.24", "unit": "KRW" },
    { "symbolCode": "CNY", "name": "Ï§ëÍµ≠ CNY", "stockExchangeType": { "nationCode": "CHN", "nationName": "Ï§ëÍµ≠" }, "calcPrice": "205.21", "closePrice": "205.21", "unit": "KRW" },
    { "symbolCode": "HKD", "name": "ÌôçÏΩ© HKD", "stockExchangeType": { "nationCode": "HKG", "nationName": "ÌôçÏΩ©" }, "calcPrice": "182.50", "closePrice": "182.50", "unit": "KRW" },
    { "symbolCode": "TWD", "name": "ÎåÄÎßå TWD", "stockExchangeType": { "nationCode": "TWN", "nationName": "ÎåÄÎßå" }, "calcPrice": "44.80", "closePrice": "44.80", "unit": "KRW" },
    { "symbolCode": "GBP", "name": "ÏòÅÍµ≠ GBP", "stockExchangeType": { "nationCode": "GBR", "nationName": "ÏòÅÍµ≠" }, "calcPrice": "1800.50", "closePrice": "1,800.50", "unit": "KRW" },
    { "symbolCode": "CAD", "name": "Ï∫êÎÇòÎã§ CAD", "stockExchangeType": { "nationCode": "CAN", "nationName": "Ï∫êÎÇòÎã§" }, "calcPrice": "1050.20", "closePrice": "1,050.20", "unit": "KRW" },
    { "symbolCode": "CHF", "name": "Ïä§ÏúÑÏä§ CHF", "stockExchangeType": { "nationCode": "CHE", "nationName": "Ïä§ÏúÑÏä§" }, "calcPrice": "1580.40", "closePrice": "1,580.40", "unit": "KRW" },
    { "symbolCode": "AUD", "name": "Ìò∏Ï£º AUD", "stockExchangeType": { "nationCode": "AUS", "nationName": "Ìò∏Ï£º" }, "calcPrice": "920.30", "closePrice": "920.30", "unit": "KRW" },
    { "symbolCode": "SGD", "name": "Ïã±Í∞ÄÌè¨Î•¥ SGD", "stockExchangeType": { "nationCode": "SGP", "nationName": "Ïã±Í∞ÄÌè¨Î•¥" }, "calcPrice": "1050.80", "closePrice": "1,050.80", "unit": "KRW" },
    { "symbolCode": "THB", "name": "ÌÉúÍµ≠ THB", "stockExchangeType": { "nationCode": "THA", "nationName": "ÌÉúÍµ≠" }, "calcPrice": "41.50", "closePrice": "41.50", "unit": "KRW" },
    { "symbolCode": "IDR", "name": "Ïù∏ÎèÑÎÑ§ÏãúÏïÑ IDR 100", "stockExchangeType": { "nationCode": "IDN", "nationName": "Ïù∏ÎèÑÎÑ§ÏãúÏïÑ" }, "calcPrice": "9.00", "closePrice": "9.00", "unit": "KRW" },
    { "symbolCode": "VND", "name": "Î≤†Ìä∏ÎÇ® VND 100", "stockExchangeType": { "nationCode": "VNM", "nationName": "Î≤†Ìä∏ÎÇ®" }, "calcPrice": "6.00", "closePrice": "6.00", "unit": "KRW" },
    { "symbolCode": "MYR", "name": "ÎßêÎ†àÏù¥ÏãúÏïÑ MYR", "stockExchangeType": { "nationCode": "MYS", "nationName": "ÎßêÎ†àÏù¥ÏãúÏïÑ" }, "calcPrice": "318.50", "closePrice": "318.50", "unit": "KRW" },
    { "symbolCode": "PHP", "name": "ÌïÑÎ¶¨ÌïÄ PHP", "stockExchangeType": { "nationCode": "PHL", "nationName": "ÌïÑÎ¶¨ÌïÄ" }, "calcPrice": "25.20", "closePrice": "25.20", "unit": "KRW" },
    { "symbolCode": "ZAR", "name": "ÎÇ®ÏïÑÍ≥µ ZAR", "stockExchangeType": { "nationCode": "ZAF", "nationName": "ÎÇ®ÏïÑÌîÑÎ¶¨Ïπ¥Í≥µÌôîÍµ≠" }, "calcPrice": "78.50", "closePrice": "78.50", "unit": "KRW" },
    { "symbolCode": "RUB", "name": "Îü¨ÏãúÏïÑ RUB", "stockExchangeType": { "nationCode": "RUS", "nationName": "Îü¨ÏãúÏïÑ" }, "calcPrice": "15.20", "closePrice": "15.20", "unit": "KRW" },
    { "symbolCode": "TRY", "name": "ÌäÄÎ•¥ÌÇ§Ïòà TRY", "stockExchangeType": { "nationCode": "TUR", "nationName": "ÌäÄÎ•¥ÌÇ§Ïòà" }, "calcPrice": "40.50", "closePrice": "40.50", "unit": "KRW" },
    { "symbolCode": "BRL", "name": "Î∏åÎùºÏßà BRL", "stockExchangeType": { "nationCode": "BRA", "nationName": "Î∏åÎùºÏßà" }, "calcPrice": "245.20", "closePrice": "245.20", "unit": "KRW" },
    { "symbolCode": "MXN", "name": "Î©ïÏãúÏΩî MXN", "stockExchangeType": { "nationCode": "MEX", "nationName": "Î©ïÏãúÏΩî" }, "calcPrice": "72.10", "closePrice": "72.10", "unit": "KRW" },
    { "symbolCode": "AED", "name": "UAE AED", "stockExchangeType": { "nationCode": "ARE", "nationName": "ÏïÑÎûçÏóêÎØ∏Î¶¨Ìä∏" }, "calcPrice": "387.60", "closePrice": "387.60", "unit": "KRW" },
    { "symbolCode": "INR", "name": "Ïù∏ÎèÑ INR", "stockExchangeType": { "nationCode": "IND", "nationName": "Ïù∏ÎèÑ" }, "calcPrice": "16.80", "closePrice": "16.80", "unit": "KRW" },
    { "symbolCode": "SAR", "name": "ÏÇ¨Ïö∞Îîî SAR", "stockExchangeType": { "nationCode": "SAU", "nationName": "ÏÇ¨Ïö∞ÎîîÏïÑÎùºÎπÑÏïÑ" }, "calcPrice": "379.50", "closePrice": "379.50", "unit": "KRW" },
    { "symbolCode": "NZD", "name": "Îâ¥ÏßàÎûúÎìú NZD", "stockExchangeType": { "nationCode": "NZL", "nationName": "Îâ¥ÏßàÎûúÎìú" }, "calcPrice": "850.20", "closePrice": "850.20", "unit": "KRW" },
    { "symbolCode": "CZK", "name": "Ï≤¥ÏΩî CZK", "stockExchangeType": { "nationCode": "CZE", "nationName": "Ï≤¥ÏΩî" }, "calcPrice": "60.50", "closePrice": "60.50", "unit": "KRW" },
    { "symbolCode": "PLN", "name": "Ìè¥ÎûÄÎìú PLN", "stockExchangeType": { "nationCode": "POL", "nationName": "Ìè¥ÎûÄÎìú" }, "calcPrice": "355.40", "closePrice": "355.40", "unit": "KRW" },
    { "symbolCode": "HUF", "name": "ÌóùÍ∞ÄÎ¶¨ HUF", "stockExchangeType": { "nationCode": "HUN", "nationName": "ÌóùÍ∞ÄÎ¶¨" }, "calcPrice": "3.80", "closePrice": "3.80", "unit": "KRW" }
];

const CURRENCY_NAMES = {
    'KRW': { name: 'ÎåÄÌïúÎØºÍµ≠ Ïõê', nation: 'ÌïúÍµ≠' },
    'USD': { name: 'ÎØ∏Íµ≠ Îã¨Îü¨', nation: 'ÎØ∏Íµ≠' },
    'EUR': { name: 'Ïú†ÎüΩ Ïú†Î°ú', nation: 'Ïú†ÎüΩÏó∞Ìï©' },
    'JPY': { name: 'ÏùºÎ≥∏ Ïóî', nation: 'ÏùºÎ≥∏' },
    'CNY': { name: 'Ï§ëÍµ≠ ÏúÑÏïà', nation: 'Ï§ëÍµ≠' },
    'HKD': { name: 'ÌôçÏΩ© Îã¨Îü¨', nation: 'ÌôçÏΩ©' },
    'TWD': { name: 'ÎåÄÎßå Îã¨Îü¨', nation: 'ÎåÄÎßå' },
    'GBP': { name: 'ÏòÅÍµ≠ ÌååÏö¥Îìú', nation: 'ÏòÅÍµ≠' },
    'CAD': { name: 'Ï∫êÎÇòÎã§ Îã¨Îü¨', nation: 'Ï∫êÎÇòÎã§' },
    'CHF': { name: 'Ïä§ÏúÑÏä§ ÌîÑÎûë', nation: 'Ïä§ÏúÑÏä§' },
    'SEK': { name: 'Ïä§Ïõ®Îç¥ ÌÅ¨Î°úÎÇò', nation: 'Ïä§Ïõ®Îç¥' },
    'AUD': { name: 'Ìò∏Ï£º Îã¨Îü¨', nation: 'Ìò∏Ï£º' },
    'NZD': { name: 'Îâ¥ÏßàÎûúÎìú Îã¨Îü¨', nation: 'Îâ¥ÏßàÎûúÎìú' },
    'CZK': { name: 'Ï≤¥ÏΩî ÏΩîÎ£®ÎÇò', nation: 'Ï≤¥ÏΩî' },
    'TRY': { name: 'ÌäÄÎ•¥ÌÇ§Ïòà Î¶¨Îùº', nation: 'ÌäÄÎ•¥ÌÇ§Ïòà' },
    'MXN': { name: 'Î©ïÏãúÏΩî ÌéòÏÜå', nation: 'Î©ïÏãúÏΩî' },
    'PLN': { name: 'Ìè¥ÎûÄÎìú Ï¶àÏõåÌã∞', nation: 'Ìè¥ÎûÄÎìú' },
    'AED': { name: 'UAE ÎîîÎ•¥Ìï®', nation: 'ÏïÑÎûçÏóêÎØ∏Î¶¨Ìä∏' },
    'SGD': { name: 'Ïã±Í∞ÄÌè¨Î•¥ Îã¨Îü¨', nation: 'Ïã±Í∞ÄÌè¨Î•¥' },
    'THB': { name: 'ÌÉúÍµ≠ Î∞îÌä∏', nation: 'ÌÉúÍµ≠' },
    'MYR': { name: 'ÎßêÎ†àÏù¥ÏãúÏïÑ ÎßÅÍπÉ', nation: 'ÎßêÎ†àÏù¥ÏãúÏïÑ' },
    'IDR': { name: 'Ïù∏ÎèÑÎÑ§ÏãúÏïÑ Î£®ÌîºÏïÑ', nation: 'Ïù∏ÎèÑÎÑ§ÏãúÏïÑ' },
    'VND': { name: 'Î≤†Ìä∏ÎÇ® Îèô', nation: 'Î≤†Ìä∏ÎÇ®' },
    'PHP': { name: 'ÌïÑÎ¶¨ÌïÄ ÌéòÏÜå', nation: 'ÌïÑÎ¶¨ÌïÄ' },
    'RUB': { name: 'Îü¨ÏãúÏïÑ Î£®Î∏î', nation: 'Îü¨ÏãúÏïÑ' },
    'ZAR': { name: 'ÎÇ®ÏïÑÍ≥µ ÎûúÎìú', nation: 'ÎÇ®ÏïÑÌîÑÎ¶¨Ïπ¥Í≥µÌôîÍµ≠' },
    'BRL': { name: 'Î∏åÎùºÏßà Î†àÏïå', nation: 'Î∏åÎùºÏßà' },
    'INR': { name: 'Ïù∏ÎèÑ Î£®Ìîº', nation: 'Ïù∏ÎèÑ' },
    'SAR': { name: 'ÏÇ¨Ïö∞Îîî Î¶¨ÏñÑ', nation: 'ÏÇ¨Ïö∞ÎîîÏïÑÎùºÎπÑÏïÑ' },
    'KWD': { name: 'Ïø†Ïõ®Ïù¥Ìä∏ ÎîîÎÇòÎ•¥', nation: 'Ïø†Ïõ®Ïù¥Ìä∏' },
    'BHD': { name: 'Î∞îÎ†àÏù∏ ÎîîÎÇòÎ•¥', nation: 'Î∞îÎ†àÏù∏' },
    'QAR': { name: 'Ïπ¥ÌÉÄÎ•¥ Î¶¨ÏñÑ', nation: 'Ïπ¥ÌÉÄÎ•¥' },
    'EGP': { name: 'Ïù¥ÏßëÌä∏ ÌååÏö¥Îìú', nation: 'Ïù¥ÏßëÌä∏' },
    'HUF': { name: 'ÌóùÍ∞ÄÎ¶¨ Ìè¨Î¶∞Ìä∏', nation: 'ÌóùÍ∞ÄÎ¶¨' },
    'DKK': { name: 'Îç¥ÎßàÌÅ¨ ÌÅ¨Î°úÎÑ§', nation: 'Îç¥ÎßàÌÅ¨' },
    'NOK': { name: 'ÎÖ∏Î•¥Ïõ®Ïù¥ ÌÅ¨Î°úÎÑ§', nation: 'ÎÖ∏Î•¥Ïõ®Ïù¥' },
    'ILS': { name: 'Ïù¥Ïä§ÎùºÏóò ÏÖ∞Ïºà', nation: 'Ïù¥Ïä§ÎùºÏóò' },
    'JOD': { name: 'ÏöîÎ•¥Îã® ÎîîÎÇòÎ•¥', nation: 'ÏöîÎ•¥Îã®' },
    'PKR': { name: 'ÌååÌÇ§Ïä§ÌÉÑ Î£®Ìîº', nation: 'ÌååÌÇ§Ïä§ÌÉÑ' },
    'BDT': { name: 'Î∞©Í∏ÄÎùºÎç∞Ïãú ÌÉÄÏπ¥', nation: 'Î∞©Í∏ÄÎùºÎç∞Ïãú' },
    'MNT': { name: 'Î™ΩÍ≥® Ìà¨Í∑∏Î¶≠', nation: 'Î™ΩÍ≥®' },
    'KZT': { name: 'Ïπ¥ÏûêÌùêÏä§ÌÉÑ ÌÖ°Í≤å', nation: 'Ïπ¥ÏûêÌùêÏä§ÌÉÑ' },
    'BND': { name: 'Î∏åÎ£®ÎÇòÏù¥ Îã¨Îü¨', nation: 'Î∏åÎ£®ÎÇòÏù¥' }
};

// ===================================
// State & Elements
// ===================================

const state = {
    exchangeRates: {},
    currencyList: [],
    lastUpdated: null,
    selectedCurrency: 'USD',
    targetCurrency: 'KRW', // Default Target
    searchMode: 'source', // 'source' (Input) or 'target' (Output)
    serviceChargeType: 'percent',
    isOptionsOpen: false,
    isOptionsOpen: false,
    isOptionsOpen: false,
    isSearchOpen: false,
    detectedTimeZone: null,
    // Option values are now persistent
    options: {
        serviceCharge: 0,
        taxRate: 0,
        feeRate: 0
    }
};

const elements = {
    currencyDisplay: document.getElementById('currencyDisplay'),
    selectedCurrencyText: document.getElementById('selectedCurrencyText'),
    currencySearchWrapper: document.getElementById('currencySearchWrapper'),
    currencySearchInput: document.getElementById('currencySearchInput'),
    closeSearchBtn: document.getElementById('closeSearchBtn'),
    currencyOptionsList: document.getElementById('currencyOptionsList'),
    currentRateDisplay: document.getElementById('currentRateDisplay'),
    detectLocationBtn: document.getElementById('detectLocationBtn'),
    localAmount: document.getElementById('localAmount'),
    currencySymbol: document.getElementById('currencySymbol'),
    optionsToggle: document.getElementById('optionsToggle'),
    optionsContent: document.getElementById('optionsContent'),
    toggleIcon: document.getElementById('toggleIcon'),
    serviceCharge: document.getElementById('serviceCharge'),
    serviceChargeUnit: document.getElementById('serviceChargeUnit'),
    tipPercentBtn: document.getElementById('tipPercentBtn'),
    tipFixedBtn: document.getElementById('tipFixedBtn'),
    tipTotalBtn: document.getElementById('tipTotalBtn'),
    taxRate: document.getElementById('taxRate'),
    feeRate: document.getElementById('feeRate'),
    resultValue: document.getElementById('resultValue'),
    resultLabel: document.getElementById('resultLabel'),
    resultSymbol: document.getElementById('resultSymbol'),
    resultAmount: document.getElementById('resultAmount'),
    resultSection: document.getElementById('resultSection'),
    resultBreakdown: document.getElementById('resultBreakdown'),
    // Target Search UI
    targetSearchWrapper: document.getElementById('targetSearchWrapper'),
    targetSearchInput: document.getElementById('targetSearchInput'),
    targetCloseBtn: document.getElementById('targetCloseBtn'),
    targetOptionsList: document.getElementById('targetOptionsList'),
    refreshRateBtn: document.getElementById('refreshRateBtn'),
    rateUpdateTime: document.getElementById('rateUpdateTime'),

    // Auth Elements
    userProfile: document.getElementById('userProfile'),
    userAvatar: document.getElementById('userAvatar'),
    userName: document.getElementById('userName'),
    signOutBtn: document.getElementById('signOutBtn'),
    cameraLockedMsg: document.getElementById('cameraLockedMsg'),

    // OCR & Receipt Elements
    cameraSection: document.getElementById('cameraSection'),
    cameraBtn: document.getElementById('cameraBtn'),
    cameraInput: document.getElementById('cameraInput'),

    // Receipt Manager
    receiptManagerBtn: document.getElementById('receiptManagerBtn'),
    receiptModal: document.getElementById('receiptModal'),
    receiptCameraBtn: document.getElementById('receiptCameraBtn'),
    receiptInput: document.getElementById('receiptInput'),
    receiptResult: document.getElementById('receiptResult'),
    receiptStatus: document.getElementById('receiptStatus'),
    receiptPreview: document.getElementById('receiptPreview'),
    saveReceiptBtn: document.getElementById('saveReceiptBtn')
};



// ===================================
// Auth Logic
// ===================================

const authState = {
    isLoggedIn: false,
    user: null,
    credential: null
};

// Global function for Google Sign-In callback
window.handleCredentialResponse = function (response) {
    if (response.credential) {
        // Decode JWT (simple decoding for display, verification should be on backend)
        const responsePayload = decodeJwtResponse(response.credential);

        authState.isLoggedIn = true;
        authState.user = responsePayload;
        authState.credential = response.credential;

        updateUIForLoginState();
    }
};

function decodeJwtResponse(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

function updateUIForLoginState() {
    if (authState.isLoggedIn && authState.user) {
        // Hide Google Btn
        const gBtn = document.querySelector('.g_id_signin');
        if (gBtn) gBtn.style.display = 'none';

        // Show Profile & Receipt Mgr
        elements.userProfile.style.display = 'flex';
        if (elements.receiptManagerBtn) elements.receiptManagerBtn.style.display = 'block';

        elements.userAvatar.src = authState.user.picture;
        elements.userName.textContent = authState.user.given_name || authState.user.name;

        // Show Camera (Visible on all devices when logged in)
        if (elements.cameraSection) elements.cameraSection.style.display = 'flex';
        if (elements.cameraLockedMsg) elements.cameraLockedMsg.style.display = 'none';
    } else {
        // Show Google Btn
        const gBtn = document.querySelector('.g_id_signin');
        if (gBtn) gBtn.style.display = 'block';

        // Hide Profile
        elements.userProfile.style.display = 'none';

        // Hide Camera, Show Lock Msg
        if (elements.cameraSection) elements.cameraSection.style.display = 'none';
        if (elements.cameraLockedMsg) {
            // Only show lock message on mobile
            elements.cameraLockedMsg.style.display = 'block';
        }
    }
}

function signOut() {
    authState.isLoggedIn = false;
    authState.user = null;
    authState.credential = null;
    google.accounts.id.disableAutoSelect();
    updateUIForLoginState();
    updateUIForLoginState();
}

function detectUserNationality() {
    // 1. Google Locale (if detected during auth - simplistic assumption)
    if (authState.user && authState.user.locale) {
        // Google locales are like 'ko', 'en', 'en-US'
        const locale = authState.user.locale;
        mapLocaleToCurrency(locale);
        return;
    }

    // 2. Browser Locale
    const browserLocale = navigator.language || navigator.userLanguage;
    mapLocaleToCurrency(browserLocale);
}

function mapLocaleToCurrency(locale) {
    if (!locale) return;
    const code = locale.split('-')[0].toLowerCase();
    const region = locale.split('-')[1] ? locale.split('-')[1].toUpperCase() : null;

    let target = 'KRW'; // Default fallback

    // Simple Mapping
    if (code === 'en') {
        if (region === 'GB') target = 'GBP'; // UK
        else if (region === 'AU') target = 'AUD';
        else if (region === 'CA') target = 'CAD';
        else target = 'USD'; // Default US
    }
    else if (code === 'ja') target = 'JPY';
    else if (code === 'zh') target = 'CNY';
    else if (code === 'ko') target = 'KRW';
    else if (code === 'fr') target = 'EUR';
    else if (code === 'de') target = 'EUR';
    else if (code === 'it') target = 'EUR';
    else if (code === 'es') target = 'EUR';
    else if (code === 'ru') target = 'RUB';
    else if (code === 'th') target = 'THB';
    else if (code === 'vi') target = 'VND';

    // Verification
    // We can only set it if it exists in our data
    // But data might not be loaded yet. We set a 'pending' detection
    // which fetchExchangeRates will check.
    state.lastDetectedCode = target; // Reuse this variable

    // But since we want "Target" currency not "Source" currency for this feature
    // Wait, the user asked for "Convert KRW to Their Currency".
    // So if I am American, I want Input=KRW, Target=USD.
    // If I am Korean, I want Input=USD, Target=KRW.

    // Logic:
    // If detected is KRW -> Source=USD (Source default), Target=KRW (Target default).
    // If detected is USD -> Source=KRW, Target=USD.

    if (target === 'KRW') {
        state.targetCurrency = 'KRW';
    } else {
        state.targetCurrency = target;
        state.selectedCurrency = 'KRW'; // Set input to KRW
    }
    state.homeCurrency = target; // Remember home currency
}

// ===================================
// Main Logic
// ===================================

async function fetchExchangeRates(forceUpdate = false) {
    // 1. Smart Cache Check
    const cached = localStorage.getItem(CONFIG.CACHE_KEY);
    let nextUpdateUnix = 0;

    if (cached) {
        try {
            const { data, timestamp, source, nextUpdate } = JSON.parse(cached);

            // "If data to bring is same... don't bring."
            // Check nextUpdate time if available
            const now = new Date().getTime();
            if (nextUpdate && now < nextUpdate) {
                // Data is still valid according to API promise
                if (forceUpdate) {
                    // Force blur before alert to remove button state on mobile
                    if (document.activeElement) document.activeElement.blur();
                    setTimeout(() => {
                        alert('ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏµúÏã†ÏûÖÎãàÎã§.\n(Îã§Ïùå ÏóÖÎç∞Ïù¥Ìä∏: ' + formatTime(new Date(nextUpdate)) + ')');
                    }, 100); // Slight increase in delay to ensure blur renders
                }
                processData(data); // Use cached
                state.lastUpdated = new Date(timestamp);
                state.nextUpdate = nextUpdate; // Restore state
                updateSourceInfo(source);
                updateRateStatus(`ÏµúÏã† Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ Ï§ë (${source}): ${formatTime(state.lastUpdated)}`);

                if (state.currencyList.length > 0) {
                    renderCurrencyOptions(state.currencyList);
                    // Auto-select logic
                    if (state.lastDetectedCode && state.exchangeRates[state.lastDetectedCode]) {
                        selectCurrency(state.lastDetectedCode);
                        state.lastDetectedCode = null;
                    } else if (!state.exchangeRates[state.selectedCurrency]) {
                        selectCurrency('USD');
                    } else {
                        selectCurrency(state.selectedCurrency);
                    }
                }
                return;
            }

            // If cache exists but might be old, use it initially if !forceUpdate
            if (!forceUpdate) {
                processData(data);
                state.lastUpdated = new Date(timestamp);
                updateSourceInfo(source);
                updateRateStatus(`Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ (${source}): ${formatTime(state.lastUpdated)}`);
                if (state.currencyList.length > 0) {
                    renderCurrencyOptions(state.currencyList);
                    // Auto-select logic
                    if (state.lastDetectedCode && state.exchangeRates[state.lastDetectedCode]) {
                        selectCurrency(state.lastDetectedCode);
                        state.lastDetectedCode = null;
                    } else if (!state.exchangeRates[state.selectedCurrency]) {
                        selectCurrency('USD');
                    } else {
                        selectCurrency(state.selectedCurrency);
                    }
                }
                return;
            }
        } catch (e) {
            console.warn('Cache invalid', e);
            localStorage.removeItem(CONFIG.CACHE_KEY);
        }
    }

    updateRateStatus('ÌôòÏú® Ï†ïÎ≥¥ Ïó∞Í≤∞ Ï§ë...');
    let success = false;
    let fetchedData = null;

    // Check if we are running in file:// mode
    const isLocalFile = window.location.protocol === 'file:';

    // 2. Try Proxies
    for (const proxy of CONFIG.PROXIES) {
        try {
            const url = proxy + encodeURIComponent(CONFIG.TARGET_URL);
            // Add timeout signal to fail fast
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout per proxy

            const response = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            let ratesData;
            // Handle different proxy response formats
            if (proxy.includes('allorigins') || proxy.includes('thingproxy')) {
                // Some proxies might return wrapped JSON or just raw. 
                // Thingproxy returns raw usually. Allorigins with 'raw' returns raw.
                // We kept 'raw' param in config for allorigins.
                ratesData = await response.json();
                // If wrapped in contents (standard allorigins without raw), handle it.
                if (ratesData.contents) ratesData = JSON.parse(ratesData.contents);
            } else {
                ratesData = await response.json();
            }

            if (!ratesData || (!Array.isArray(ratesData) && !ratesData.rates && ratesData.result !== 'success')) throw new Error('Invalid data');

            fetchedData = ratesData;
            processData(ratesData); // Changed from processExchangeData
            success = true;
            break;
        } catch (e) {
            console.warn(`Proxy ${proxy} failed:`, e);
        }
    }

    // 3. Backup API (Naver)
    if (!success) {
        try {
            const res = await fetch(CONFIG.BACKUP_API);
            if (res.ok) {
                const data = await res.json();
                fetchedData = data; // Store for caching
                processData(data); // Changed from processBackupData
                state.lastUpdated = new Date();
                // updateRateStatus(`ÏóÖÎç∞Ïù¥Ìä∏ (Naver/Hana Bank): ${formatTime(state.lastUpdated)}`); // This will be handled by the common caching block
                success = true;
            }
        } catch (e) {
            console.warn('Backup failed:', e);
        }
    }

    // 4. Fallback (Offline hardcoded)
    if (!success) {
        processData(FALLBACK_DATA); // Changed from processExchangeData
        updateRateStatus('Ïò§ÌîÑÎùºÏù∏ Î™®Îìú (Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©)');
    } else if (fetchedData) {
        state.lastUpdated = new Date();

        let finalSource = 'Unknown';
        let nextUpdate = 0;

        // determine source type
        if (Array.isArray(fetchedData)) {
            finalSource = 'Naver/Hana Bank';
            // Naver doesn't give next update, assume 1 hour? Or just 0.
        } else if (fetchedData.result === 'success' || fetchedData.rates) {
            finalSource = 'Global Standard API';
            if (fetchedData.time_next_update_unix) {
                nextUpdate = fetchedData.time_next_update_unix * 1000;
            }
        }

        updateSourceInfo(finalSource);
        updateRateStatus(`ÏóÖÎç∞Ïù¥Ìä∏ (${finalSource}): ${formatTime(state.lastUpdated)}`);

        try {
            const cachePayload = {
                data: fetchedData,
                timestamp: state.lastUpdated.getTime(),
                source: finalSource,
                nextUpdate: nextUpdate
            };
            localStorage.setItem(CONFIG.CACHE_KEY, JSON.stringify(cachePayload));
        } catch (e) {
            console.warn('Cache write failed', e);
        }
    }

    if (state.currencyList.length > 0) {
        renderCurrencyOptions(state.currencyList);

        // Auto-select if pending detection exists (e.g. init race condition)
        if (state.lastDetectedCode && state.exchangeRates[state.lastDetectedCode]) {
            selectCurrency(state.lastDetectedCode);
            state.lastDetectedCode = null; // Consume
        } else if (!state.exchangeRates[state.selectedCurrency]) {
            selectCurrency('USD');
        } else {
            selectCurrency(state.selectedCurrency);
        }
    }
}

function processBackupData(data) {
    state.exchangeRates = {};
    state.currencyList = [];

    // ExchangeRate-API returns rates relative to base (KRW)
    // "rates": { "USD": 0.00075, ... } -> 1 KRW = 0.00075 USD
    // We need KRW per 1 Unit -> 1 / 0.00075

    const rates = data.rates || {};

    Object.keys(CURRENCY_NAMES).forEach(code => {
        const val = rates[code];
        if (val) {
            const rate = 1 / val;
            let displayRate = rate;

            // JPY, VND, IDR are typically shown per 100 units in UI, but logic uses per 1 unit
            if (['JPY', 'VND', 'IDR'].includes(code)) {
                displayRate = rate * 100;
            }

            const currencyObj = {
                code: code,
                name: CURRENCY_NAMES[code].name,
                nationName: CURRENCY_NAMES[code].nation,
                rate: rate,
                displayRate: formatNumber(displayRate, 2)
            };

            state.exchangeRates[code] = currencyObj;
            state.currencyList.push(currencyObj);
        }
    });

    // Explicitly Add KRW
    addKrwToState();

    const majors = ['USD', 'EUR', 'JPY', 'CNY', 'GBP', 'VND', 'IDR', 'KRW'];
    state.currencyList.sort((a, b) => {
        const idxA = majors.indexOf(a.code);
        const idxB = majors.indexOf(b.code);
        if (idxA !== -1 && idxB !== -1) return idxA - idxB;
        if (idxA !== -1) return -1;
        if (idxB !== -1) return 1;
        return a.nationName.localeCompare(b.nationName);
    });
}

function processData(data) {
    // Unify processing. Detect type.
    if (Array.isArray(data)) {
        processNaverData(data);
    } else if (data.rates || (data.result === 'success')) {
        processGlobalData(data);
    }
}

function addKrwToState() {
    const krwObj = {
        code: 'KRW',
        name: 'ÎåÄÌïúÎØºÍµ≠ Ïõê',
        nationName: 'ÌïúÍµ≠',
        rate: 1.0,
        displayRate: '1.00'
    };
    state.exchangeRates['KRW'] = krwObj;
    // Check if distinct to avoid dupes (though logic clears list first)
    state.currencyList.push(krwObj);
}

function updateSourceInfo(sourceName) {
    const footer = document.getElementById('sourceInfo');
    if (footer) {
        if (sourceName.includes('Naver')) {
            footer.innerHTML = 'ÌôòÏú® Ï†ïÎ≥¥: ÌïòÎÇòÏùÄÌñâ (Naver)';
        } else {
            footer.innerHTML = 'ÌôòÏú® Ï†ïÎ≥¥: Global Standard API (ExchangeRate-API)';
        }
    }
}

function processGlobalData(data) {
    state.exchangeRates = {};
    state.currencyList = [];

    const rates = data.rates || {};
    Object.keys(CURRENCY_NAMES).forEach(code => {
        const val = rates[code];
        if (val) {
            const rate = 1 / val;
            let displayRate = rate;
            if (['JPY', 'VND', 'IDR'].includes(code)) displayRate = rate * 100;

            const currencyObj = {
                code: code,
                name: CURRENCY_NAMES[code].name,
                nationName: CURRENCY_NAMES[code].nation,
                rate: rate,
                displayRate: formatNumber(displayRate, 2)
            };
            state.exchangeRates[code] = currencyObj;
            state.currencyList.push(currencyObj);
        }
    });

    // Explicitly Add KRW
    addKrwToState();

    sortCurrencyList();
}

function processNaverData(rawData) {
    state.exchangeRates = {};
    state.currencyList = [];
    const processedCodes = new Set();

    rawData.forEach(item => {
        if (!item.symbolCode || !item.calcPrice) return;
        const code = item.symbolCode;
        if (processedCodes.has(code)) return;

        let rate = parseFloat(item.calcPrice.replace(/,/g, ''));
        if (isNaN(rate)) return;

        let finalRate = rate;
        if (['JPY', 'VND', 'IDR'].includes(code)) finalRate = rate / 100;

        const mapped = CURRENCY_NAMES[code] || {};
        const nationName = mapped.nation || item.stockExchangeType?.nationName || getCountryFromCode(code);
        const currencyName = mapped.name || item.name || code;

        const currencyObj = {
            code: code,
            name: currencyName,
            nationName: nationName,
            rate: finalRate,
            displayRate: item.closePrice
        };
        state.exchangeRates[code] = currencyObj;
        state.currencyList.push(currencyObj);
        processedCodes.add(code);
    });

    // Explicitly Add KRW
    addKrwToState();

    sortCurrencyList();
}

function sortCurrencyList() {
    const majors = ['USD', 'EUR', 'JPY', 'CNY', 'GBP', 'VND', 'IDR'];
    state.currencyList.sort((a, b) => {
        const idxA = majors.indexOf(a.code);
        const idxB = majors.indexOf(b.code);
        if (idxA !== -1 && idxB !== -1) return idxA - idxB;
        if (idxA !== -1) return -1;
        if (idxB !== -1) return 1;
        return a.nationName.localeCompare(b.nationName);
    });
}

function renderCurrencyOptions(list) {
    elements.currencyOptionsList.innerHTML = '';
    if (list.length === 0) {
        elements.currencyOptionsList.innerHTML = '<div class="no-results">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
        return;
    }
    list.forEach(item => {
        const option = document.createElement('div');
        option.className = 'option-item';

        let isSelected = false;
        if (state.searchMode === 'target') {
            isSelected = (item.code === state.targetCurrency);
        } else {
            isSelected = (item.code === state.selectedCurrency);
        }

        if (isSelected) option.classList.add('selected');

        option.innerHTML = `
            <div class="option-info">
                <span class="option-name">${item.nationName}</span>
                <span class="option-code">(${item.code})</span>
            </div>
            ${isSelected ? '<span style="color:var(--accent-primary)">‚úî</span>' : ''}
        `;
        option.addEventListener('click', () => selectCurrency(item.code));
        elements.currencyOptionsList.appendChild(option);
    });
}

const EUROZONE_COUNTRIES = [
    'AT', 'BE', 'HR', 'CY', 'EE', 'FI', 'FR', 'DE', 'GR', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', 'PT', 'SK', 'SI', 'ES', 'AD', 'MC', 'SM', 'VA'
];

function openSearch(mode = 'source') {
    state.searchMode = mode;
    state.isSearchOpen = true;

    // UI Separation: Show correct wrapper
    if (mode === 'target') {
        elements.targetSearchWrapper.style.display = 'block';
        elements.currencySearchWrapper.style.display = 'none'; // Ensure source closed

        elements.targetSearchInput.value = '';
        elements.targetSearchInput.focus();
        renderCurrencyOptions(state.currencyList); // Renders to targetOptionsList
    } else {
        // Source Mode
        elements.currencyDisplay.style.display = 'none';
        elements.currencySearchWrapper.style.display = 'block';
        elements.targetSearchWrapper.style.display = 'none'; // Ensure target closed

        elements.currencySearchInput.value = '';
        elements.currencySearchInput.focus();
        renderCurrencyOptions(state.currencyList); // Renders to currencyOptionsList
    }
}

function closeSearch() {
    state.isSearchOpen = false;
    elements.currencyDisplay.style.display = 'flex';
    elements.currencySearchWrapper.style.display = 'none';
    elements.targetSearchWrapper.style.display = 'none';
}

function filterCurrencyList(keyword) {
    if (!keyword) {
        renderCurrencyOptions(state.currencyList);
        return;
    }
    const lower = keyword.toLowerCase();
    const filtered = state.currencyList.filter(item =>
        item.code.toLowerCase().includes(lower) ||
        item.name.toLowerCase().includes(lower) ||
        item.nationName.toLowerCase().includes(lower)
    );
    renderCurrencyOptions(filtered);
}

// Renders the list of currencies
// Uses state.searchMode to decide WHICH list to populate
function renderCurrencyOptions(list) {
    const listContainer = (state.searchMode === 'target') ?
        elements.targetOptionsList :
        elements.currencyOptionsList;

    if (!listContainer) return;

    listContainer.innerHTML = '';
    if (list.length === 0) {
        listContainer.innerHTML = '<div class="no-results">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</div>';
        return;
    }

    list.forEach(item => {
        const option = document.createElement('div');
        option.className = 'option-item';

        let isSelected = false;
        if (state.searchMode === 'target') {
            isSelected = (item.code === state.targetCurrency);
        } else {
            isSelected = (item.code === state.selectedCurrency);
        }

        if (isSelected) option.classList.add('selected');

        option.innerHTML = `
            <div class="option-info">
                <span class="option-name">${item.nationName}</span>
                <span class="option-code">(${item.code})</span>
            </div>
            ${isSelected ? '<span style="color:var(--accent-primary)">‚úî</span>' : ''}
        `;
        option.addEventListener('click', () => selectCurrency(item.code));
        listContainer.appendChild(option);
    });
}

function selectCurrency(code) {
    if (!state.exchangeRates[code]) return;

    if (state.searchMode === 'target') {
        // Mode: Setting Target (Home) Currency
        // STRICT SEPARATION: Only change Target & Home. Never Source.
        state.targetCurrency = code;
        state.homeCurrency = code; // Remember preference

        // No checks on source logic.

    } else {
        // Mode: Setting Source (Input) Currency
        state.selectedCurrency = code;

        // Auto-Swap Logic (Foreigner Mode)
        if (code === 'KRW') {
            state.targetCurrency = state.homeCurrency || 'USD';
            // User Feedback: Don't force USD. If homeCurrency is KRW (or unassigned), let it be.
            // if (state.targetCurrency === 'KRW') state.targetCurrency = 'USD';
        } else {
            state.targetCurrency = 'KRW';
        }
    }

    // Reset UI Logic
    if (state.searchMode === 'source') {
        // If Source changed, reset input amount
        elements.localAmount.value = '';
        toggleClearBtn('localAmount', '');

        // Reset Service Charge
        if (state.serviceChargeType !== 'percent') {
            elements.serviceCharge.value = '';
            toggleClearBtn('serviceCharge', '');
        }
    }

    closeSearch();

    // Update Display Text (Source only)
    if (state.searchMode === 'source') {
        const rate = state.exchangeRates[state.selectedCurrency];
        elements.selectedCurrencyText.textContent = `${rate.nationName} (${rate.code})`;
        elements.currencySymbol.textContent = getCurrencySymbol(state.selectedCurrency);
    }

    calculate();
}



// ===================================
// UI Interaction Logic
// ===================================

function openSearch(mode = 'source') {
    state.searchMode = mode;
    state.isSearchOpen = true;

    // Position the search wrapper based on mode? 
    // For now, it's absolute top left, which is fine for both.
    // Ideally we want it to cover the relevant section, but full cover is safer.

    elements.currencyDisplay.style.display = 'none'; // Hide source display
    // If target mode, we might want to hide result label? 
    // Actually search wrapper covers everything in 'currency-interaction-wrapper'
    // But resultLabel is outside that.

    // Let's just make search wrapper visible.
    elements.currencySearchWrapper.style.display = 'block';

    const input = elements.currencySearchInput;
    input.value = '';
    input.placeholder = mode === 'source' ? 'ÏûÖÎ†• ÌôîÌèê Í≤ÄÏÉâ...' : 'ÎÇ¥ ÌôîÌèê(Íµ≠Ï†Å) Í≤ÄÏÉâ...';

    renderCurrencyOptions(state.currencyList);
    input.focus();
}

function closeSearch() {
    state.isSearchOpen = false;
    elements.currencySearchWrapper.style.display = 'none';
    elements.currencyDisplay.style.display = 'flex';
}

function filterCurrencyList(query) {
    const lowerQuery = query.toLowerCase();
    const filtered = state.currencyList.filter(item =>
        item.code.toLowerCase().includes(lowerQuery) ||
        item.name.toLowerCase().includes(lowerQuery) ||
        item.nationName.toLowerCase().includes(lowerQuery)
    );
    renderCurrencyOptions(filtered);
}

// ===================================
// Helper: Input Handling (Commas)
// ===================================

function handleNumberInput(e) {
    let value = e.target.value.replace(/[^0-9.]/g, '');

    // Ensure only one dot
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }

    // Add commas to integer part
    if (parts[0]) {
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    const formatted = parts.join('.');
    if (e.target.value !== formatted) {
        e.target.value = formatted;
    }

    calculate();
}

// ===================================
// Calculations & Helpers
// ===================================

function calculate() {
    const localAmount = parseFloat(elements.localAmount.value.replace(/,/g, '')) || 0;
    const serviceChargeInput = parseFloat(elements.serviceCharge.value.replace(/,/g, '')) || 0;
    const taxRate = parseFloat(elements.taxRate.value.replace(/,/g, '')) || 0;
    const feeRate = parseFloat(elements.feeRate.value.replace(/,/g, '')) || 0;

    if (!state.exchangeRates[state.selectedCurrency]) return;
    const sourceRate = state.exchangeRates[state.selectedCurrency].rate;

    // Safety check for target currency (default to KRW if missing)
    if (!state.exchangeRates[state.targetCurrency]) {
        state.targetCurrency = 'KRW';
    }
    const targetRate = state.exchangeRates[state.targetCurrency]?.rate || 1;

    let serviceCharge = 0;
    if (state.serviceChargeType === 'percent') {
        serviceCharge = localAmount * (serviceChargeInput / 100);
    } else if (state.serviceChargeType === 'fixed') {
        serviceCharge = serviceChargeInput;
    } else if (state.serviceChargeType === 'total') {
        if (serviceChargeInput > localAmount) {
            serviceCharge = serviceChargeInput - localAmount;
        } else {
            serviceCharge = 0;
        }
    }

    const withService = localAmount + serviceCharge;
    const withTax = withService * (1 + taxRate / 100);
    const withFee = withTax * (1 + feeRate / 100);

    // Core Calculation: Input * (Source / Target)
    const resultValue = withFee * (sourceRate / targetRate);

    // Dynamic Decimal Places
    // If target is KRW/JPY/VND etc, 0 decimals. Else 2.
    const targetCode = state.targetCurrency;
    const decimals = ['KRW', 'JPY', 'VND', 'IDR'].includes(targetCode) ? 0 : 2;



    elements.resultValue.textContent = formatNumber(resultValue, decimals);

    // Update Result UI (Label & Symbol)
    const targetSymbol = getCurrencySymbol(targetCode);
    const targetName = state.exchangeRates[targetCode]?.name || targetCode;

    if (elements.resultLabel) elements.resultLabel.textContent = `${targetName} (${targetCode})`;
    if (elements.resultSymbol) elements.resultSymbol.textContent = targetSymbol;

    updateBreakdown({
        localAmount, serviceCharge, withService, taxRate,
        withTax, feeRate, withFee, sourceRate, targetRate, resultValue, targetCode
    });
}

function updateBreakdown(data) {
    const symbol = getCurrencySymbol(state.selectedCurrency);
    let html = '';
    if (data.localAmount > 0) {
        html = `
            <div class="breakdown-item"><span>Í∏∞Î≥∏ Í∏àÏï°</span><span>${symbol}${formatNumber(data.localAmount, 2)}</span></div>
        `;
        if (data.serviceCharge > 0) {
            let scLabel = '+ ÏÑúÎπÑÏä§Ï∞®ÏßÄ';
            if (state.serviceChargeType === 'percent') {
                scLabel += ` (${elements.serviceCharge.value}%)`;
            } else if (state.serviceChargeType === 'fixed') {
                scLabel += ` (Ï†ïÏï°)`;
            } else if (state.serviceChargeType === 'total') {
                scLabel += ` (Ìï©ÏÇ∞)`;
            }
            html += itemRow(scLabel, data.serviceCharge, symbol);
        }
        if (data.taxRate > 0) html += itemRow(`+ ÏÑ∏Í∏à (${data.taxRate}%)`, data.withService * (data.taxRate / 100), symbol);
        if (data.feeRate > 0) html += itemRow(`+ ÏàòÏàòÎ£å (${data.feeRate}%)`, data.withTax * (data.feeRate / 100), symbol);

        if (data.feeRate > 0) html += itemRow(`+ ÏàòÏàòÎ£å (${data.feeRate}%)`, data.withTax * (data.feeRate / 100), symbol);

        const targetSymbol = getCurrencySymbol(data.targetCode);
        html += `
            <div class="breakdown-item"><span>Î≥ÄÌôò Í∏àÏï° (${data.targetCode})</span><span>${targetSymbol}${formatNumber(data.resultValue, 2)}</span></div>
        `;
    }
    elements.resultBreakdown.innerHTML = html;
}

function itemRow(label, value, symbol) {
    return `<div class="breakdown-item"><span>${label}</span><span>${symbol}${formatNumber(value, 2)}</span></div>`;
}

function getCountryFromCode(currencyCode) {
    const map = { 'USD': 'ÎØ∏Íµ≠', 'KRW': 'ÌïúÍµ≠', 'EUR': 'Ïú†ÎüΩ', 'JPY': 'ÏùºÎ≥∏', 'CNY': 'Ï§ëÍµ≠' };
    return map[currencyCode] || currencyCode;
}

function getCurrencySymbol(code) {
    const symbols = {
        'USD': '$', 'EUR': '‚Ç¨', 'JPY': '¬•', 'CNY': '¬•', 'GBP': '¬£',
        'KRW': '‚Ç©', 'THB': '‡∏ø', 'VND': '‚Ç´', 'PHP': '‚Ç±', 'INR': '‚Çπ'
    };
    return symbols[code] || code;
}

function formatTime(date) {
    const options = {
        month: 'numeric',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    if (state.detectedTimeZone) {
        try {
            options.timeZone = state.detectedTimeZone;
        } catch (e) {
            console.warn('Invalid TimeZone:', state.detectedTimeZone);
        }
    }
    return date.toLocaleTimeString('ko-KR', options);
}

function formatNumber(num, decimals = 0) {
    return num.toLocaleString('ko-KR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

function updateRateStatus(message) {
    elements.rateUpdateTime.textContent = message;
}

// ===================================
// Initialization
// ===================================

function initEventListeners() {
    // Auto Detect on Init
    detectUserNationality();

    elements.currencyDisplay.addEventListener('click', () => openSearch('source'));

    // Result Label Click -> Search 'target'
    // Result Label Click -> Search 'target'
    const openTargetSearch = (e) => {
        // Prevent triggering if clicking something interactive inside (if any)
        // But here everything is just text/display.
        e.stopPropagation();
        openSearch('target');
    };

    if (elements.resultLabel) elements.resultLabel.addEventListener('click', openTargetSearch);
    // Attach to the container (resultAmount) instead of individual spans for better touch area
    if (elements.resultAmount) elements.resultAmount.addEventListener('click', openTargetSearch);

    // Also attach to the whole section just in case? 
    // Maybe too aggressive, users might click by accident. Result Amount and Label is enough.
    // Let's stick to Amount and Label.

    elements.closeSearchBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        closeSearch();
    });
    elements.currencySearchInput.addEventListener('input', (e) => filterCurrencyList(e.target.value));

    // Target Search Listeners
    if (elements.targetCloseBtn) {
        elements.targetCloseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeSearch();
        });
    }
    if (elements.targetSearchInput) {
        elements.targetSearchInput.addEventListener('input', (e) => filterCurrencyList(e.target.value));
    }

    document.addEventListener('click', (e) => {
        // If search is open, check which one and close if active out
        if (!state.isSearchOpen) return;

        if (state.searchMode === 'target') {
            if (!elements.targetSearchWrapper.contains(e.target) &&
                !elements.resultSection.contains(e.target)) {
                closeSearch();
            }
        } else {
            if (!elements.currencySearchWrapper.contains(e.target) &&
                !elements.currencyDisplay.contains(e.target)) {
                closeSearch();
            }
        }
    });

    // Unified number input handler with Persistence
    elements.localAmount.addEventListener('input', (e) => {
        handleNumberInput(e);
        toggleClearBtn('localAmount', e.target.value);
    });

    ['serviceCharge', 'taxRate', 'feeRate'].forEach(id => {
        elements[id].addEventListener('input', (e) => {
            handleNumberInput(e);
            toggleClearBtn(id, e.target.value);
            saveOptions(); // Save on change
        });
    });

    // Validation for Total Mode
    elements.serviceCharge.addEventListener('blur', (e) => {
        // Skip validation if clicking Clear Button or Type Button
        if (e.relatedTarget && (
            e.relatedTarget.classList.contains('clear-btn') ||
            e.relatedTarget.classList.contains('type-btn')
        )) {
            return;
        }

        if (state.serviceChargeType === 'total') {
            const localAmount = parseFloat(elements.localAmount.value.replace(/,/g, '')) || 0;
            const inputVal = parseFloat(elements.serviceCharge.value.replace(/,/g, '')) || 0;



            // If input exists and is less than base amount, warn user
            if (inputVal > 0 && inputVal < localAmount) {
                alert('Ìï©ÏÇ∞ Í∏àÏï°ÏùÄ Í∏∞Î≥∏ Í∏àÏï°Î≥¥Îã§ Ïª§Ïïº Ìï©ÎãàÎã§.\n(ÌåÅÏùÑ Ìè¨Ìï®Ìïú Ï¥ùÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî)');
                setTimeout(() => {
                    elements.serviceCharge.focus();
                }, 10);
            }
        }
    });

    // Clear Buttons
    document.querySelectorAll('.clear-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const targetId = btn.dataset.target;
            const input = document.getElementById(targetId);
            if (input) {
                input.value = '';
                toggleClearBtn(targetId, '');
                input.focus();
                calculate(); // Recalculate
                if (['serviceCharge', 'taxRate', 'feeRate'].includes(targetId)) {
                    saveOptions(); // Save clear state
                }
            }
        });
    });

    elements.optionsToggle.addEventListener('click', () => {
        state.isOptionsOpen = !state.isOptionsOpen;
        elements.optionsContent.classList.toggle('open', state.isOptionsOpen);
        elements.toggleIcon.classList.toggle('open', state.isOptionsOpen);
    });

    elements.tipPercentBtn.addEventListener('click', () => {
        state.serviceChargeType = 'percent';
        elements.tipPercentBtn.classList.add('active');
        elements.tipFixedBtn.classList.remove('active');
        elements.tipTotalBtn.classList.remove('active');
        elements.serviceChargeUnit.textContent = '%';
        calculate();
    });
    elements.tipFixedBtn.addEventListener('click', () => {
        state.serviceChargeType = 'fixed';
        elements.tipFixedBtn.classList.add('active');
        elements.tipPercentBtn.classList.remove('active');
        elements.tipTotalBtn.classList.remove('active');
        elements.serviceChargeUnit.textContent = getCurrencySymbol(state.selectedCurrency);
        calculate();
    });
    elements.tipTotalBtn.addEventListener('click', () => {
        state.serviceChargeType = 'total';
        elements.tipTotalBtn.classList.add('active');
        elements.tipPercentBtn.classList.remove('active');
        elements.tipFixedBtn.classList.remove('active');
        elements.serviceChargeUnit.textContent = getCurrencySymbol(state.selectedCurrency);
        calculate();
    });

    elements.refreshRateBtn.addEventListener('click', async () => {
        await fetchExchangeRates(true);
        elements.refreshRateBtn.blur();
    });
    elements.detectLocationBtn.addEventListener('click', () => detectLocation(true));

    // Auth Listeners
    if (elements.signOutBtn) {
        elements.signOutBtn.addEventListener('click', signOut);
    }
}

// Timezone to Currency Mapping
const TIMEZONE_CURRENCY_MAP = {
    // Asia
    'Asia/Seoul': 'KRW',
    'Asia/Tokyo': 'JPY',
    'Asia/Shanghai': 'CNY',
    'Asia/Chongqing': 'CNY',
    'Asia/Hong_Kong': 'HKD',
    'Asia/Taipei': 'TWD',
    'Asia/Singapore': 'SGD',
    'Asia/Bangkok': 'THB',
    'Asia/Ho_Chi_Minh': 'VND',
    'Asia/Saigon': 'VND',
    'Asia/Jakarta': 'IDR',
    'Asia/Kuala_Lumpur': 'MYR',
    'Asia/Manila': 'PHP',
    'Asia/Kolkata': 'INR',
    'Asia/Dubai': 'AED',
    'Asia/Riyadh': 'SAR',
    'Asia/Ulaanbaatar': 'MNT',
    'Asia/Almaty': 'KZT',
    'Asia/Brunei': 'BND',

    // Europe (Eurozone)
    'Europe/Paris': 'EUR',
    'Europe/Berlin': 'EUR',
    'Europe/Rome': 'EUR',
    'Europe/Madrid': 'EUR',
    'Europe/Amsterdam': 'EUR',
    'Europe/Brussels': 'EUR',
    'Europe/Vienna': 'EUR',
    'Europe/Athens': 'EUR',
    'Europe/Dublin': 'EUR',
    'Europe/Lisbon': 'EUR',
    'Europe/Helsinki': 'EUR',
    'Europe/Luxembourg': 'EUR',

    // Europe (Non-Eurozone)
    'Europe/London': 'GBP',
    'Europe/Zurich': 'CHF',
    'Europe/Stockholm': 'SEK',
    'Europe/Oslo': 'NOK',
    'Europe/Copenhagen': 'DKK',
    'Europe/Warsaw': 'PLN',
    'Europe/Prague': 'CZK',
    'Europe/Budapest': 'HUF',
    'Europe/Moscow': 'RUB',
    'Europe/Istanbul': 'TRY',

    // Americas
    'America/New_York': 'USD',
    'America/Chicago': 'USD',
    'America/Denver': 'USD',
    'America/Los_Angeles': 'USD',
    'America/Anchorage': 'USD',
    'America/Phoenix': 'USD',
    'Pacific/Honolulu': 'USD',
    'Pacific/Guam': 'USD',
    'America/Toronto': 'CAD',
    'America/Vancouver': 'CAD',
    'America/Montreal': 'CAD',
    'America/Mexico_City': 'MXN',
    'America/Sao_Paulo': 'BRL',
    'America/Buenos_Aires': 'ARS',

    // Oceania
    'Australia/Sydney': 'AUD',
    'Australia/Melbourne': 'AUD',
    'Australia/Brisbane': 'AUD',
    'Australia/Perth': 'AUD',
    'Pacific/Auckland': 'NZD',

    // Africa & Middle East
    'Africa/Johannesburg': 'ZAR',
    'Africa/Cairo': 'EGP',
    'Asia/Jerusalem': 'ILS',
    'Asia/Amman': 'JOD'
};

function detectLocation(interactive = false) {
    try {
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        state.detectedTimeZone = timezone;

        let targetCode = TIMEZONE_CURRENCY_MAP[timezone];

        // Fallback: try to match by region prefix
        if (!targetCode) {
            const region = timezone.split('/')[0];
            if (region === 'Europe') targetCode = 'EUR';
            else if (region === 'America') targetCode = 'USD';
            else if (region === 'Asia') targetCode = 'USD'; // Default for unknown Asian timezones
            else targetCode = 'USD';
        }

        state.lastDetectedCode = targetCode;

        // Find matching currency
        const found = state.currencyList.find(c => c.code === targetCode);

        if (found) {
            selectCurrency(found.code);
            if (interactive) {
                alert(`üåç ÌÉÄÏûÑÏ°¥: ${timezone}\nüí∞ ÌôîÌèê: ${found.code} ÏÑ†ÌÉùÎê®`);
            }
        } else if (state.exchangeRates[targetCode]) {
            selectCurrency(targetCode);
            if (interactive) {
                alert(`üåç ÌÉÄÏûÑÏ°¥: ${timezone}\nüí∞ ÌôîÌèê: ${targetCode} ÏÑ†ÌÉùÎê®`);
            }
        } else {
            if (interactive) {
                alert(`üåç ÌÉÄÏûÑÏ°¥: ${timezone}\n‚ö†Ô∏è Ìï¥Îãπ ÌôîÌèê Ï†ïÎ≥¥ ÏóÜÏùå (Í∏∞Î≥∏: USD)`);
            }
        }

        console.log(`Timezone detected: ${timezone} ‚Üí ${targetCode}`);
    } catch (e) {
        console.error('Timezone detection failed:', e);
        if (interactive) alert('ÌÉÄÏûÑÏ°¥ Í∞êÏßÄ Ïã§Ìå®');
    }
}

function init() {
    initEventListeners();

    // Load saved options first (restores selectedCurrency)
    loadOptions();

    updateRateStatus('ÌôòÏú® Ï†ïÎ≥¥ Î°úÎî© Ï§ë...');

    // Timezone-based detection (synchronous, no permission needed)
    detectLocation(false);

    // Fetch exchange rates
    fetchExchangeRates(false);

    if (CONFIG.UPDATE_INTERVAL > 0) {
        setInterval(() => fetchExchangeRates(true), CONFIG.UPDATE_INTERVAL);
    }
    // Initial calculate call might be empty if no rates yet, but UI structure initializes.
    calculate();

    // Initial Toggle check
    toggleClearBtn('localAmount', elements.localAmount.value);
    toggleClearBtn('serviceCharge', elements.serviceCharge.value);
    toggleClearBtn('taxRate', elements.taxRate.value);
    toggleClearBtn('feeRate', elements.feeRate.value);
}

function saveOptions() {
    let scVal = elements.serviceCharge.value;
    // Only save value if type is percent
    if (state.serviceChargeType !== 'percent') {
        scVal = '';
    }

    const options = {
        serviceCharge: scVal,
        taxRate: elements.taxRate.value,
        feeRate: elements.feeRate.value,
        serviceChargeType: state.serviceChargeType,
        selectedCurrency: state.selectedCurrency // Persist currency
    };
    localStorage.setItem('currency_calculator_options', JSON.stringify(options));
}

function loadOptions() {
    const saved = localStorage.getItem('currency_calculator_options');
    if (saved) {
        try {
            const options = JSON.parse(saved);
            if (options.serviceCharge !== undefined) elements.serviceCharge.value = options.serviceCharge;
            if (options.taxRate !== undefined) elements.taxRate.value = options.taxRate;
            if (options.feeRate !== undefined) elements.feeRate.value = options.feeRate;
            if (options.serviceChargeType) {
                state.serviceChargeType = options.serviceChargeType;
                if (state.serviceChargeType === 'fixed') {
                    elements.tipFixedBtn.click();
                } else if (state.serviceChargeType === 'total') {
                    elements.tipTotalBtn.click();
                } else {
                    elements.tipPercentBtn.click();
                }
            }
            if (options.selectedCurrency) {
                state.selectedCurrency = options.selectedCurrency;
            }
        } catch (e) {
            console.warn('Options load failed', e);
        }
    }
}

function toggleClearBtn(id, value) {
    const btn = document.querySelector(`.clear-btn[data-target="${id}"]`);
    if (btn) {
        if (value && value.length > 0) {
            btn.classList.add('visible');
        } else {
            btn.classList.remove('visible');
        }
    }
}

// ===================================
// OCR (Optical Character Recognition)
// ===================================

let tesseractLoaded = false;
let tesseractWorker = null;

// Load Tesseract.js from CDN
async function loadTesseract() {
    if (tesseractLoaded) return true;

    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
        script.onload = () => {
            tesseractLoaded = true;
            console.log('Tesseract.js loaded');
            resolve(true);
        };
        script.onerror = () => reject(new Error('Failed to load Tesseract.js'));
        document.head.appendChild(script);
    });
}

// Initialize OCR Worker
async function initOCRWorker() {
    if (tesseractWorker) return tesseractWorker;

    await loadTesseract();

    tesseractWorker = await Tesseract.createWorker(['eng', 'chi_sim'], 1, {
        logger: m => {
            if (m.status === 'recognizing text') {
                const progress = Math.round(m.progress * 100);
                if (elements.ocrStatus) {
                    elements.ocrStatus.textContent = `Ïù∏Ïãù Ï§ë... ${progress}%`;
                }
            }
        }
    });

    return tesseractWorker;
}

// Extract prices from OCR text
function extractPrices(text) {
    const prices = [];

    // Currency symbol patterns (before or after number)
    // ¬• (U+00A5), Ôø• (U+FFE5), ÂÖÉ, ÂÜÜ, ‚Ç© for Asian currencies
    const patterns = [
        /[$‚Ç¨¬£¬•Ôø•‚Ç©‚Çπ‡∏ø‚ÇΩÂÖÉÂÜÜ]\s*([\d,\.]+)/g,                    // ¬•120.00, $12.50
        /([\d,\.]+)\s*[$‚Ç¨¬£¬•Ôø•‚Ç©‚Çπ‡∏ø‚ÇΩÂÖÉÂÜÜ]/g,                    // 120.00¬•, 12.50$
        /(\d+(?:[,.]\d{1,2})?)/g                             // Plain numbers: 120, 12.50
    ];

    const seen = new Set();

    for (const pattern of patterns) {
        let match;
        while ((match = pattern.exec(text)) !== null) {
            // Extract the numeric part
            let numStr = match[1] || match[0];
            numStr = numStr.replace(/[$‚Ç¨¬£¬•\s]/g, '').replace(/,/g, '');

            const num = parseFloat(numStr);
            if (!isNaN(num) && num > 0 && num < 1000000 && !seen.has(num)) {
                seen.add(num);
                prices.push({
                    value: num,
                    original: match[0].trim()
                });
            }
        }
    }

    // Sort by value descending
    prices.sort((a, b) => b.value - a.value);

    return prices.slice(0, 10); // Return top 10 prices
}

// Image Preprocessing for better OCR accuracy
function preprocessImage(imageFile) {
    return new Promise((resolve) => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = (e) => {
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Scale up small images for better recognition
                const minSize = 1000;
                let width = img.width;
                let height = img.height;

                if (width < minSize && height < minSize) {
                    const scale = minSize / Math.max(width, height);
                    width *= scale;
                    height *= scale;
                }

                canvas.width = width;
                canvas.height = height;

                // Draw original image
                ctx.drawImage(img, 0, 0, width, height);

                // Get image data
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;

                // Step 1: Grayscale conversion
                for (let i = 0; i < data.length; i += 4) {
                    const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                    data[i] = gray;     // R
                    data[i + 1] = gray; // G
                    data[i + 2] = gray; // B
                }

                // Step 2: Contrast enhancement (1.5x)
                const contrast = 1.5;
                const factor = (259 * (contrast * 100 + 255)) / (255 * (259 - contrast * 100));
                for (let i = 0; i < data.length; i += 4) {
                    data[i] = Math.min(255, Math.max(0, factor * (data[i] - 128) + 128));
                    data[i + 1] = data[i];
                    data[i + 2] = data[i];
                }

                // Step 3: Binarization (Otsu's threshold approximation)
                // Calculate histogram
                const histogram = new Array(256).fill(0);
                for (let i = 0; i < data.length; i += 4) {
                    histogram[Math.floor(data[i])]++;
                }

                // Find optimal threshold
                const total = width * height;
                let sum = 0, sumB = 0, wB = 0, wF = 0;
                let maxVariance = 0, threshold = 128;

                for (let i = 0; i < 256; i++) sum += i * histogram[i];

                for (let t = 0; t < 256; t++) {
                    wB += histogram[t];
                    if (wB === 0) continue;
                    wF = total - wB;
                    if (wF === 0) break;

                    sumB += t * histogram[t];
                    const mB = sumB / wB;
                    const mF = (sum - sumB) / wF;
                    const variance = wB * wF * (mB - mF) * (mB - mF);

                    if (variance > maxVariance) {
                        maxVariance = variance;
                        threshold = t;
                    }
                }

                // Apply threshold
                for (let i = 0; i < data.length; i += 4) {
                    const value = data[i] > threshold ? 255 : 0;
                    data[i] = value;
                    data[i + 1] = value;
                    data[i + 2] = value;
                }

                ctx.putImageData(imageData, 0, 0);

                // Return as Base64 String (Fixed)
                try {
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    resolve(dataUrl.split(',')[1]);
                } catch (e) {
                    reject(e);
                }
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(imageFile);
    });
}

// ===================================
// Receipt Modal Logic
// ===================================

function openReceiptModal() {
    if (elements.receiptModal) elements.receiptModal.style.display = 'flex';
    resetReceiptModal();
}

function closeReceiptModal() {
    if (elements.receiptModal) elements.receiptModal.style.display = 'none';
}

function resetReceiptModal() {
    if (elements.receiptResult) elements.receiptResult.style.display = 'none';
    if (elements.saveReceiptBtn) {
        elements.saveReceiptBtn.style.display = 'none';
        elements.saveReceiptBtn.onclick = null;
        elements.saveReceiptBtn.disabled = false;
        elements.saveReceiptBtn.textContent = 'üíæ Í∞ÄÍ≥ÑÎ∂ÄÏóê Ï†ÄÏû•';
    }
    if (elements.receiptStatus) elements.receiptStatus.textContent = "ÏòÅÏàòÏ¶ùÏùÑ Ï¥¨ÏòÅÌïòÍ±∞ÎÇò ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî.";
    if (elements.receiptPreview) elements.receiptPreview.innerHTML = "";
}

// ===================================

// ===================================
// AI Logic (Dual Mode)
// ===================================

// Mode 1: Fast Price Tag Scan (Main Screen)
async function scanPriceTag(file) {
    if (!authState.isLoggedIn) {
        alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í∏∞Îä•ÏûÖÎãàÎã§.");
        return;
    }

    const originalText = elements.cameraBtn.innerHTML;
    elements.cameraBtn.innerHTML = '<span>‚è≥ Î∂ÑÏÑù Ï§ë...</span>';
    elements.cameraBtn.disabled = true;

    try {
        const base64Image = await preprocessImage(file);

        // Call Gemini with 'price_tag' mode
        const result = await callGeminiOCR(base64Image, 'price_tag');

        if (result.success && result.data) {
            const data = result.data;

            // 1. Auto-set Currency
            if (data.currency) {
                let detectedCode = data.currency.trim().toUpperCase();

                // Debug log
                console.log(`[DEBUG] AI Raw: ${data.currency} / Codes: ${detectedCode}`);

                // Symbol to Code Mapping (All Keys UPPERCASE)
                const symbolMap = {
                    '$': 'USD', 'US$': 'USD', 'USD': 'USD',
                    '‚Ç¨': 'EUR', 'EUR': 'EUR',
                    '¬£': 'GBP', 'GBP': 'GBP',
                    '¬•': 'JPY', 'JPY': 'JPY', 'YEN': 'JPY',
                    'ÂÖÉ': 'CNY', 'CNY': 'CNY', 'RMB': 'CNY', 'CN¬•': 'CNY',
                    '‚Ç©': 'KRW', 'KRW': 'KRW', 'WON': 'KRW',
                    '‡∏ø': 'THB', 'THB': 'THB', 'BAHT': 'THB',
                    '‚Ç´': 'VND', 'VND': 'VND', 'DONG': 'VND',
                    '‚Ç±': 'PHP', 'PHP': 'PHP',
                    'RP': 'IDR', 'IDR': 'IDR',
                    'RS': 'INR', 'INR': 'INR', '‚Çπ': 'INR'
                };

                if (symbolMap[detectedCode]) {
                    detectedCode = symbolMap[detectedCode];
                }

                // Find matching currency in our list
                const mapped = state.currencyList.find(c => c.code === detectedCode);

                if (mapped && detectedCode !== state.selectedCurrency) {
                    console.log(`Currency switched: ${state.selectedCurrency} -> ${detectedCode}`);
                    selectCurrency(detectedCode);

                    // Visual feedback
                    elements.selectedCurrencyText.style.color = '#38dec8';
                    setTimeout(() => elements.selectedCurrencyText.style.color = '', 800);
                } else if (!mapped) {
                    console.warn(`Detected currency '${data.currency}' (mapped: ${detectedCode}) not supported.`);
                }
            }

            // 2. Auto-set Amount
            if (data.total) {
                setInput(data.total);

                // Visual Feedback
                elements.localAmount.style.backgroundColor = '#e8f5e9'; // Light Green
                setTimeout(() => elements.localAmount.style.backgroundColor = '', 500);
            } else {
                alert("Í∞ÄÍ≤© Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
            }
        } else {
            console.error("OCR Failed:", result);
            throw new Error(result.error + (result.details ? "\nDetails:\n" + result.details : ""));
        }
    } catch (e) {
        alert("Ïò§Î•ò: " + e.message);
    } finally {
        elements.cameraBtn.innerHTML = originalText;
        elements.cameraBtn.disabled = false;
        elements.cameraInput.value = '';
    }
}

// Mode 2: Detailed Receipt Scan (Modal)
async function scanReceipt(file) {
    if (elements.receiptResult) elements.receiptResult.style.display = 'block';
    if (elements.receiptStatus) elements.receiptStatus.textContent = "AIÍ∞Ä ÏòÅÏàòÏ¶ùÏùÑ ÏÉÅÏÑ∏ Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§... (ÏïΩ 5-7Ï¥à)";
    if (elements.receiptPreview) elements.receiptPreview.innerHTML = "";
    if (elements.saveReceiptBtn) elements.saveReceiptBtn.style.display = 'none';

    try {
        const base64Image = await preprocessImage(file);
        const result = await callGeminiOCR(base64Image, 'receipt');

        if (result.success && result.data) {
            const data = result.data;
            if (elements.receiptStatus) elements.receiptStatus.textContent = "‚úÖ Î∂ÑÏÑù ÏôÑÎ£å";

            // Symbol Mapping for Receipt
            let displayCurrency = data.currency;
            if (displayCurrency) {
                const upCurrency = displayCurrency.toUpperCase();
                const symbolMap = {
                    '$': 'USD', '‚Ç¨': 'EUR', '¬£': 'GBP', '¬•': 'JPY', 'ÂÖÉ': 'CNY', 'CN¬•': 'CNY',
                    '‚Ç©': 'KRW', '‡∏ø': 'THB', '‚Ç´': 'VND', '‚Ç±': 'PHP', 'RP': 'IDR', 'Rp': 'IDR', '‚Çπ': 'INR'
                };
                if (symbolMap[displayCurrency]) displayCurrency = symbolMap[displayCurrency];
                else if (symbolMap[upCurrency]) displayCurrency = symbolMap[upCurrency];
            }

            let html = `<strong>üìÖ ÎÇ†Ïßú:</strong> ${data.date || 'ÎØ∏ÏÉÅ'}<br>`;
            html += `<strong>üè™ ÏÉÅÌò∏:</strong> ${data.store || 'ÎØ∏ÏÉÅ'}<br>`;
            html += `<strong>üí∞ Ï¥ùÏï°:</strong> ${data.total} ${displayCurrency}<br>`;
            html += `<strong>üí≥ Í≤∞Ï†ú:</strong> ${data.paymentMethod || 'ÎØ∏ÏÉÅ'}<br>`;
            html += `<hr><strong>üìù ÌíàÎ™© (ÌïúÍµ≠Ïñ¥ Î≤àÏó≠Îê®):</strong><br>`;

            if (data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    html += `- ${item.name}: ${item.price}<br>`;
                });
            } else {
                html += `(ÏÑ∏Î∂Ä ÌíàÎ™© ÏóÜÏùå)<br>`;
            }

            if (elements.receiptPreview) elements.receiptPreview.innerHTML = html;

            if (elements.saveReceiptBtn) {
                elements.saveReceiptBtn.style.display = 'block';
                const newBtn = elements.saveReceiptBtn.cloneNode(true);
                elements.saveReceiptBtn.parentNode.replaceChild(newBtn, elements.saveReceiptBtn);
                elements.saveReceiptBtn = newBtn;
                elements.saveReceiptBtn.textContent = 'üíæ Í∞ÄÍ≥ÑÎ∂ÄÏóê Ï†ÄÏû•';
                elements.saveReceiptBtn.disabled = false;
                elements.saveReceiptBtn.onclick = () => saveReceiptToSheet({ ...data, currency: displayCurrency });
            }

        } else {
            throw new Error(result.error);
        }
    } catch (e) {
        if (elements.receiptStatus) elements.receiptStatus.textContent = "‚ùå Ïò§Î•ò: " + e.message;
    } finally {
        if (elements.receiptInput) elements.receiptInput.value = '';
    }
}

// Helper: Call Gemini Backend
async function callGeminiOCR(base64Image, mode) {
    try {
        const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
            method: 'POST',
            redirect: 'follow',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({
                action: 'ocr',
                image: base64Image,
                mode: mode || 'price_tag', // Pass mode to backend
                mimeType: 'image/jpeg'
            })
        });

        if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
        return await response.json();
    } catch (e) {
        console.error(e);
        throw new Error("ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: " + e.message);
    }
}

// Helper: Save Receipt
async function saveReceiptToSheet(receiptData) {
    const btn = elements.saveReceiptBtn;
    if (!btn) return;

    btn.disabled = true;
    btn.textContent = "Ï†ÄÏû• Ï§ë...";

    try {
        const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
            method: 'POST',
            redirect: 'follow',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({
                action: 'save',
                userEmail: authState.user.email,
                receiptData: receiptData
            })
        });

        const res = await response.json();
        if (res.success) {
            alert("‚úÖ Í∞ÄÍ≥ÑÎ∂ÄÏóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!");
            closeReceiptModal();
        } else {
            throw new Error(res.error);
        }
    } catch (e) {
        alert("Ï†ÄÏû• Ïã§Ìå®: " + e.message);
        btn.disabled = false;
        btn.textContent = "üíæ Í∞ÄÍ≥ÑÎ∂ÄÏóê Ï†ÄÏû•";
    }
}

// setInput - Fixed Clear Button Visibility
function setInput(val) {
    if (elements.localAmount) {
        elements.localAmount.value = val;
        calculate();

        // Manual toggle of clear button
        const btn = document.querySelector(`.clear-btn[data-target="localAmount"]`);
        if (btn) {
            if (val && val.toString().length > 0) btn.classList.add('visible');
            else btn.classList.remove('visible');
        }
    }
}

// initOCRListeners - Robust Event Binding
function initOCRListeners() {
    console.log("Initializing OCR Listeners (Robust)...");

    // 1. Fast Price Tag Scan
    if (elements.cameraBtn && elements.cameraInput) {
        elements.cameraBtn.onclick = () => elements.cameraInput.click();
        elements.cameraInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) scanPriceTag(file);
        }
    }

    // 2. Receipt Manager Modal - Direct Binding
    const receiptBtn = document.getElementById('receiptManagerBtn');
    if (receiptBtn) {
        receiptBtn.onclick = (e) => {
            e.preventDefault();
            console.log("Receipt Manager Clicked");
            openReceiptModal();
        };
    } else {
        console.warn("Receipt Manager Button not found during init!");
    }

    if (elements.receiptCameraBtn && elements.receiptInput) {
        elements.receiptCameraBtn.onclick = () => elements.receiptInput.click();
        elements.receiptInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) scanReceipt(file);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    init();
    // Delay initialization slightly to ensure DOM is ready
    setTimeout(initOCRListeners, 200);
});

</script>
</body>

</html>
